const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const log = require('../../util/log');
const ml5 = require('ml5');

/**
 * Formatter which is used for translating.
 * When it was loaded as a module, 'formatMessage' will be replaced which is used in the runtime.
 * @type {Function}
 */
let formatMessage = require('format-message');

/**
 * URL to get this extension as a module.
 * When it was loaded as a module, 'extensionURL' will be replaced a URL which is retrieved from.
 * @type {string}
 */
let extensionURL = 'https://champierre.github.io/ml2scratch/ml2scratch.mjs';

const HAT_TIMEOUT = 100;

const blockIconURI = 'data:image/png;base64,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UmVhZHlxyWU8AAADI2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6N0M2OEYzRjJEODlFMTFFQUIzMzU4RDkyMDIwMkVDNUIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6N0M2OEYzRjNEODlFMTFFQUIzMzU4RDkyMDIwMkVDNUIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3QzY4RjNGMEQ4OUUxMUVBQjMzNThEOTIwMjAyRUM1QiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3QzY4RjNGMUQ4OUUxMUVBQjMzNThEOTIwMjAyRUM1QiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PjgTCIUAACClSURBVHja7HwJeBzVle65VdX7JrXUko3kTV6CbGNjwGEJA4QAA8PgsIS8eQbGZIFMFshj8pJMhmVIMnGGzOPNJCGTsCWEZV6S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';

const Message = {
  train_label_1: {
    'ja': 'ラベル1を学習する',
    'ja-Hira': 'ラベル1をがくしゅうする',
    'en': 'train label 1',
    'zh-cn': '学习标签1',
    'zh-tw': '學習標籤1'
  },
  train_label_2: {
    'ja': 'ラベル2を学習する',
    'ja-Hira': 'ラベル2をがくしゅうする',
    'en': 'train label 2',
    'zh-cn': '学习标签2',
    'zh-tw': '學習標籤2'
  },
  train_label_3: {
    'ja': 'ラベル3を学習する',
    'ja-Hira': 'ラベル3をがくしゅうする',
    'en': 'train label 3',
    'zh-cn': '学习标签3',
    'zh-tw': '學習標籤3'
  },
  train: {
    'ja': 'ラベル[LABEL]を学習する',
    'ja-Hira': 'ラベル[LABEL]をがくしゅうする',
    'en': 'train label [LABEL]',
    'zh-cn': '学习标签[LABEL]',
    'zh-tw': '學習標籤[LABEL]'
  },
  when_received_block: {
    'ja': 'ラベル[LABEL]を受け取ったとき',
    'ja-Hira': 'ラベル[LABEL]をうけとったとき',
    'en': 'when received label:[LABEL]',
    'zh-cn': '接收到类别[LABEL]时',
    'zh-tw': '接收到類別[LABEL]時'
  },
  label_block: {
    'ja': 'ラベル',
    'ja-Hira': 'ラベル',
    'en': 'label',
    'zh-cn': '标签',
    'zh-tw': '標籤'
  },
  counts_label_1: {
    'ja': 'ラベル1の枚数',
    'ja-Hira': 'ラベル1のまいすう',
    'en': 'counts of label 1',
    'zh-cn': '标签数量1',
    'zh-tw': '標籤數量1'
  },
  counts_label_2: {
    'ja': 'ラベル2の枚数',
    'ja-Hira': 'ラベル2のまいすう',
    'en': 'counts of label 2',
    'zh-cn': '标签数量2',
    'zh-tw': '標籤數量2'
  },
  counts_label_3: {
    'ja': 'ラベル3の枚数',
    'ja-Hira': 'ラベル3のまいすう',
    'en': 'counts of label 3',
    'zh-cn': '标签数量3',
    'zh-tw': '標籤數量3'
  },
  counts_label_4: {
    'ja': 'ラベル4の枚数',
    'ja-Hira': 'ラベル4のまいすう',
    'en': 'counts of label 4',
    'zh-cn': '标签数量4',
    'zh-tw': '標籤數量4'
  },
  counts_label_5: {
    'ja': 'ラベル5の枚数',
    'ja-Hira': 'ラベル5のまいすう',
    'en': 'counts of label 5',
    'zh-cn': '标签数量5',
    'zh-tw': '標籤數量5'
  },
  counts_label_6: {
    'ja': 'ラベル6の枚数',
    'ja-Hira': 'ラベル6のまいすう',
    'en': 'counts of label 6',
    'zh-cn': '标签数量6',
    'zh-tw': '標籤數量6'
  },
  counts_label_7: {
    'ja': 'ラベル7の枚数',
    'ja-Hira': 'ラベル7のまいすう',
    'en': 'counts of label 7',
    'zh-cn': '标签数量7',
    'zh-tw': '標籤數量7'
  },
  counts_label_8: {
    'ja': 'ラベル8の枚数',
    'ja-Hira': 'ラベル8のまいすう',
    'en': 'counts of label 8',
    'zh-cn': '标签数量8',
    'zh-tw': '標籤數量8'
  },
  counts_label_9: {
    'ja': 'ラベル9の枚数',
    'ja-Hira': 'ラベル9のまいすう',
    'en': 'counts of label 9',
    'zh-cn': '标签数量9',
    'zh-tw': '標籤數量9'
  },
  counts_label_10: {
    'ja': 'ラベル10の枚数',
    'ja-Hira': 'ラベル10のまいすう',
    'en': 'counts of label 10',
    'zh-cn': '标签数量10',
    'zh-tw': '標籤數量10'
  },
  counts_label: {
    'ja': 'ラベル[LABEL]の枚数',
    'ja-Hira': 'ラベル[LABEL]のまいすう',
    'en': 'counts of label [LABEL]',
    'zh-cn': '标签数量[LABEL]',
    'zh-tw': '標籤數量[LABEL]'
  },
  any: {
    'ja': 'のどれか',
    'ja-Hira': 'のどれか',
    'en': 'any',
    'zh-cn': '任何',
    'zh-tw': '任何'
  },
  all: {
    'ja': 'の全て',
    'ja-Hira': 'のすべて',
    'en': 'all',
    'zh-cn': '所有',
    'zh-tw': '所有量'
  },
  reset: {
    'ja': 'ラベル[LABEL]の学習をリセット',
    'ja-Hira': 'ラベル[LABEL]のがくしゅうをリセット',
    'en': 'reset label:[LABEL]',
    'zh-cn': '重置[LABEL]',
    'zh-tw': '重置[LABEL]'
  },
  download_learning_data: {
    'ja': '学習データをダウンロード',
    'ja-Hira': 'がくしゅうデータをダウンロード',
    'en': 'download learning data',
    'zh-cn': '下载学习数据',
    'zh-tw': '下載學習資料'
  },
  upload_learning_data: {
    'ja': '学習データをアップロード',
    'ja-Hira': 'がくしゅうデータをアップロード',
    'en': 'upload learning data',
    'zh-cn': '上传学习数据',
    'zh-tw': '上傳學習資料'
  },
  upload: {
    'ja': 'アップロード',
    'ja-Hira': 'アップロード',
    'en': 'upload',
    'zh-cn': '上传',
    'zh-tw': '上傳'
  },
  uploaded: {
    'ja': 'アップロードが完了しました。',
    'ja-Hira': 'アップロードがかんりょうしました。',
    'en': 'The upload is complete.',
    'zh-cn': '上传完成。',
    'zh-tw': '上傳完成。'
  },
  upload_instruction: {
    'ja': 'ファイルを選び、アップロードボタンをクリックして下さい。',
    'ja-Hira': 'ファイルをえらび、アップロードボタンをクリックしてください。',
    'en': 'Select a file and click the upload button.',
    'zh-cn': '选择一个文件，然后单击上传按钮。',
    'zh-tw': '選擇一個檔案，然後點擊上傳按鈕'
  },
  confirm_reset: {
    'ja': '本当にリセットしてもよろしいですか？',
    'ja-Hira': 'ほんとうにリセットしてもよろしいですか？',
    'en': 'Are you sure to reset?',
    'zh-cn': '你确定要重置吗？',
    'zh-tw': '您確定要重置嗎？'
  },
  toggle_classification: {
    'ja': 'ラベル付けを[CLASSIFICATION_STATE]にする',
    'ja-Hira': 'ラベルづけを[CLASSIFICATION_STATE]にする',
    'en': 'turn classification [CLASSIFICATION_STATE]',
    'zh-cn': '[CLASSIFICATION_STATE]分类',
    'zh-tw': '[CLASSIFICATION_STATE]分類'
  },
  set_classification_interval: {
    'ja': 'ラベル付けを[CLASSIFICATION_INTERVAL]秒間に1回行う',
    'ja-Hira': 'ラベルづけを[CLASSIFICATION_INTERVAL]びょうかんに1かいおこなう',
    'en': 'Label once every [CLASSIFICATION_INTERVAL] seconds',
    'zh-cn': '每隔[CLASSIFICATION_INTERVAL]秒标记一次',
    'zh-tw': '每隔[CLASSIFICATION_INTERVAL]秒標記一次'
  },
  video_toggle: {
    'ja': 'ビデオを[VIDEO_STATE]にする',
    'ja-Hira': 'ビデオを[VIDEO_STATE]にする',
    'en': 'turn video [VIDEO_STATE]',
    'zh-cn': '[VIDEO_STATE]摄像头',
    'zh-tw': '視訊設為[VIDEO_STATE]'
  },
  set_input: {
    'ja': '[INPUT]の画像を学習/判定する',
    'ja-Hira': '[INPUT]のがぞうをがくしゅう/はんていする',
    'en': 'Learn/Classify [INPUT] image',
    'zh-cn': '学习/分类[INPUT]图像',
	'zh-tw': '學習/分類[INPUT]影像'
  },
  on: {
    'ja': '入',
    'ja-Hira': 'いり',
    'en': 'on',
    'zh-cn': '开启',
    'zh-tw': '開啟'
  },
  off: {
    'ja': '切',
    'ja-Hira': 'きり',
    'en': 'off',
    'zh-cn': '关闭',
    'zh-tw': '關閉'
  },
  video_on_flipped: {
    'ja': '左右反転',
    'ja-Hira': 'さゆうはんてん',
    'en': 'on flipped',
    'zh-cn': '镜像开启',
    'zh-tw': '翻轉'
  },
  webcam: {
    'ja': 'カメラ',
    'ja-Hira': 'カメラ',
    'en': 'webcam',
    'zh-cn': '网络摄像头',
    'zh-tw': '網路攝影機'
  },
  stage: {
    'ja': 'ステージ',
    'ja-Hira': 'ステージ',
    'en': 'stage',
    'zh-cn': '舞台',
    'zh-tw': '舞台'
  },
  first_training_warning: {
    'ja': '最初の学習にはしばらく時間がかかるので、何度もクリックしないで下さい。',
    'ja-Hira': 'さいしょのがくしゅうにはしばらくじかんがかかるので、なんどもクリックしないでください。',
    'en': 'The first training will take a while, so do not click again and again.',
    'zh-cn': '第一项研究需要一段时间，所以不要一次又一次地点击。',
    'zh-tw': '第一次訓練需要一段時間，請稍後，不要一直點擊。'
  }
}

const AvailableLocales = ['en', 'ja', 'ja-Hira', 'zh-cn', 'zh-tw'];

class Scratch3ML2ScratchBlocks {

  /**
   * @return {string} - the name of this extension.
   */
  static get EXTENSION_NAME() {
    return 'ML2Scratch';
  }

  /**
   * @return {string} - the ID of this extension.
   */
  static get EXTENSION_ID() {
    return 'ml2scratch';
  }

  /**
   * URL to get this extension.
   * @type {string}
   */
  static get extensionURL() {
    return extensionURL;
  }

  /**
   * Set URL to get this extension.
   * extensionURL will be reset when the module is loaded from the web.
   * @param {string} url - URL
   */
  static set extensionURL(url) {
    extensionURL = url;
  }

  constructor(runtime) {
    this.runtime = runtime;
    if (runtime.formatMessage) {
      // Replace 'formatMessage' to a formatter which is used in the runtime.
      formatMessage = runtime.formatMessage;
    }

    this.when_received = false;
    this.when_received_arr = Array(8).fill(false);
    this.label = null;
    this.locale = this.setLocale();

    this.blockClickedAt = null;

    this.counts = null;
    this.firstTraining = true;

    this.interval = 1000;
    this.globalVideoTransparency = 0;
    this.setVideoTransparency({
        TRANSPARENCY: this.globalVideoTransparency
    });

    this.canvas = document.querySelector('canvas');

    this.runtime.ioDevices.video.enableVideo().then(() => {this.input = this.runtime.ioDevices.video.provider.video});

    this.knnClassifier = ml5.KNNClassifier();
    this.featureExtractor = ml5.featureExtractor('MobileNet', () => {
      console.log('[featureExtractor] Model Loaded!');
      this.timer = setInterval(() => {
        this.classify();
      }, this.interval);
    });
  }

  getInfo() {
    this.locale = this.setLocale();

    return {
      id: Scratch3ML2ScratchBlocks.EXTENSION_ID,
      name: 'ML w Scratch',
      extensionURL: Scratch3ML2ScratchBlocks.extensionURL,
      blockIconURI: blockIconURI,
      blocks: [
        {
          opcode: 'addExample1',
          blockType: BlockType.COMMAND,
          text: Message.train_label_1[this.locale]
        },
        {
          opcode: 'addExample2',
          blockType: BlockType.COMMAND,
          text: Message.train_label_2[this.locale]
        },
        {
          opcode: 'addExample3',
          blockType: BlockType.COMMAND,
          text: Message.train_label_3[this.locale]
        },
        {
          opcode: 'train',
          text: Message.train[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              menu: 'train_menu',
              defaultValue: '4'
            }
          }
        },
        {
          opcode: 'trainAny',
          text: Message.train[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              defaultValue: '11'
            }
          }
        },
        {
          opcode: 'getLabel',
          text: Message.label_block[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'whenReceived',
          text: Message.when_received_block[this.locale],
          blockType: BlockType.HAT,
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              menu: 'received_menu',
              defaultValue: 'any'
            }
          }
        },
        {
          opcode: 'whenReceivedAny',
          text: Message.when_received_block[this.locale],
          blockType: BlockType.HAT,
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              defaultValue: '11'
            }
          }
        },
        {
          opcode: 'getCountByLabel1',
          text: Message.counts_label_1[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel2',
          text: Message.counts_label_2[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel3',
          text: Message.counts_label_3[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel4',
          text: Message.counts_label_4[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel5',
          text: Message.counts_label_5[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel6',
          text: Message.counts_label_6[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel7',
          text: Message.counts_label_7[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel8',
          text: Message.counts_label_8[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel9',
          text: Message.counts_label_9[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel10',
          text: Message.counts_label_10[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getCountByLabel',
          text: Message.counts_label[this.locale],
          blockType: BlockType.REPORTER,
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              defaultValue: '11'
            }
          }
        },
        {
          opcode: 'reset',
          blockType: BlockType.COMMAND,
          text: Message.reset[this.locale],
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              menu: 'reset_menu',
              defaultValue: 'all'
            }
          }
        },
        {
          opcode: 'resetAny',
          blockType: BlockType.COMMAND,
          text: Message.reset[this.locale],
          arguments: {
            LABEL: {
              type: ArgumentType.STRING,
              defaultValue: '11'
            }
          }
        },
        {
          opcode: 'download',
          text: Message.download_learning_data[this.locale],
          blockType: BlockType.COMMAND
        },
        {
          opcode: 'upload',
          text: Message.upload_learning_data[this.locale],
          blockType: BlockType.COMMAND
        },
        {
          opcode: 'toggleClassification',
          text: Message.toggle_classification[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            CLASSIFICATION_STATE: {
              type: ArgumentType.STRING,
              menu: 'classification_menu',
              defaultValue: 'off'
            }
          }
        },
        {
          opcode: 'setClassificationInterval',
          text: Message.set_classification_interval[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            CLASSIFICATION_INTERVAL: {
              type: ArgumentType.STRING,
              menu: 'classification_interval_menu',
              defaultValue: '1'
            }
          }
        },
        {
          opcode: 'videoToggle',
          text: Message.video_toggle[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            VIDEO_STATE: {
              type: ArgumentType.STRING,
              menu: 'video_menu',
              defaultValue: 'off'
            }
          }
        },
        {
          opcode: 'setVideoTransparency',
          text: formatMessage({
              id: 'videoSensing.setVideoTransparency',
              default: 'set video transparency to [TRANSPARENCY]',
              description: 'Controls transparency of the video preview layer'
          }),
          arguments: {
              TRANSPARENCY: {
                  type: ArgumentType.NUMBER,
                  defaultValue: 50
              }
          }
        },
        {
          opcode: 'setInput',
          text: Message.set_input[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            INPUT: {
              type: ArgumentType.STRING,
              menu: 'input_menu',
              defaultValue: 'webcam'
            }
          }
        }

      ],
      menus: {
        received_menu: {
          items: this.getMenu('received')
        },
        reset_menu: {
          items: this.getMenu('reset')
        },
        train_menu: {
          items: this.getTrainMenu()
        },
        count_menu: {
          items: this.getTrainMenu()
        },
        video_menu: this.getVideoMenu(),
        classification_interval_menu: {
          acceptReporters: true,
          items: this.getClassificationIntervalMenu()
        },
        classification_menu: this.getClassificationMenu(),
        input_menu: this.getInputMenu()
      }
    };
  }

  /**
   * The transparency setting of the video preview stored in a value
   * accessible by any object connected to the virtual machine.
   * @type {number}
   */
  get globalVideoTransparency () {
      const stage = this.runtime.getTargetForStage();
      if (stage) {
          return stage.videoTransparency;
      }
      return 50;
  }

  set globalVideoTransparency (transparency) {
      const stage = this.runtime.getTargetForStage();
      if (stage) {
          stage.videoTransparency = transparency;
      }
      return transparency;
  }

  addExample1() {
    this.firstTrainingWarning();
    let features = this.featureExtractor.infer(this.input);
    this.knnClassifier.addExample(features, '1');
    this.updateCounts();
  }

  addExample2() {
    this.firstTrainingWarning();
    let features = this.featureExtractor.infer(this.input);
    this.knnClassifier.addExample(features, '2');
    this.updateCounts();
  }

  addExample3() {
    this.firstTrainingWarning();
    let features = this.featureExtractor.infer(this.input);
    this.knnClassifier.addExample(features, '3');
    this.updateCounts();
  }

  train(args) {
    this.firstTrainingWarning();
    let features = this.featureExtractor.infer(this.input);
    this.knnClassifier.addExample(features, args.LABEL);
    this.updateCounts();
  }

  trainAny(args) {
    this.train(args);
  }

  getLabel() {
    return this.label;
  }

  whenReceived(args) {
    if (args.LABEL === 'any') {
      if (this.when_received) {
        setTimeout(() => {
            this.when_received = false;
        }, HAT_TIMEOUT);
        return true;
      }
      return false;
    } else {
      if (this.when_received_arr[args.LABEL]) {
        setTimeout(() => {
          this.when_received_arr[args.LABEL] = false;
        }, HAT_TIMEOUT);
        return true;
      }
      return false;
    }
  }

  whenReceivedAny(args) {
    return this.whenReceived(args);
  }

  getCountByLabel1() {
    if (this.counts) {
      return this.counts['1'];
    } else {
      return 0;
    }
  }

  getCountByLabel2() {
    if (this.counts) {
      return this.counts['2'];
    } else {
      return 0;
    }
  }

  getCountByLabel3() {
    if (this.counts) {
      return this.counts['3'];
    } else {
      return 0;
    }
  }

  getCountByLabel4() {
    if (this.counts) {
      return this.counts['4'];
    } else {
      return 0;
    }
  }

  getCountByLabel5() {
    if (this.counts) {
      return this.counts['5'];
    } else {
      return 0;
    }
  }

  getCountByLabel6() {
    if (this.counts) {
      return this.counts['6'];
    } else {
      return 0;
    }
  }

  getCountByLabel7() {
    if (this.counts) {
      return this.counts['7'];
    } else {
      return 0;
    }
  }

  getCountByLabel8() {
    if (this.counts) {
      return this.counts['8'];
    } else {
      return 0;
    }
  }

  getCountByLabel9() {
    if (this.counts) {
      return this.counts['9'];
    } else {
      return 0;
    }
  }

  getCountByLabel10() {
    if (this.counts) {
      return this.counts['10'];
    } else {
      return 0;
    }
  }

  getCountByLabel(args) {
    if (this.counts[args.LABEL]) {
      return this.counts[args.LABEL];
    } else {
      return 0;
    }
  }

  reset(args) {
    if (this.actionRepeated()) { return };

    setTimeout(() => {
      let result = confirm(Message.confirm_reset[this.locale]);
      if (result) {
        if (args.LABEL == 'all') {
          this.knnClassifier.clearAllLabels();
          for (let label in this.counts) {
            this.counts[label] = 0;
          }
        } else {
          if (this.counts[args.LABEL] > 0) {
            this.knnClassifier.clearLabel(args.LABEL);
            this.counts[args.LABEL] = 0;
          }
        }
      }
    }, 1000);
  }

  resetAny(args) {
    this.reset(args);
  }

  download() {
    if (this.actionRepeated()) { return };
    let fileName = String(Date.now());
    this.knnClassifier.save(fileName);
  }

  upload() {
    if (this.actionRepeated()) { return };
    let width = 480;
    let height = 200;
    let left = window.innerWidth / 2;
    let top = window.innerHeight / 2;
    let x = left - (width / 2);
    let y = top - (height / 2);
    uploadWindow = window.open('', null, 'top=' + y + ',left=' + x + ',width=' + width + ',height=' + height);
    uploadWindow.document.open();
    uploadWindow.document.write('<html><head><title>' + Message.upload_learning_data[this.locale] + '</title></head><body>');
    uploadWindow.document.write('<p>' + Message.upload_instruction[this.locale] + '</p>');
    uploadWindow.document.write('<input type="file" id="upload-files">');
    uploadWindow.document.write('<input type="button" value="' + Message.upload[this.locale] + '" id="upload-button">');
    uploadWindow.document.write('</body></html>');
    uploadWindow.document.close();

    uploadWindow.document.getElementById("upload-button").onclick = () =>{
      this.uploadButtonClicked(uploadWindow);
    }
  }

  toggleClassification (args) {
    let state = args.CLASSIFICATION_STATE;
    if (this.timer) {
      clearTimeout(this.timer);
    }
    if (state === 'on') {
      this.timer = setInterval(() => {
        this.classify();
      }, this.interval);
    }
  }

  setClassificationInterval (args) {
    if (this.timer) {
      clearTimeout(this.timer);
    }

    this.interval = args.CLASSIFICATION_INTERVAL * 1000;
    this.timer = setInterval(() => {
      this.classify();
    }, this.interval);
  }

  videoToggle (args) {
    let state = args.VIDEO_STATE;
    if (state === 'off') {
      this.runtime.ioDevices.video.disableVideo();
    } else {
      this.runtime.ioDevices.video.enableVideo().then(() => {this.input = this.runtime.ioDevices.video.provider.video});
      this.runtime.ioDevices.video.mirror = state === "on";
    }
  }

  /**
   * A scratch command block handle that configures the video preview's
   * transparency from passed arguments.
   * @param {object} args - the block arguments
   * @param {number} args.TRANSPARENCY - the transparency to set the video
   *   preview to
   */
  setVideoTransparency (args) {
      const transparency = Cast.toNumber(args.TRANSPARENCY);
      this.globalVideoTransparency = transparency;
      this.runtime.ioDevices.video.setPreviewGhost(transparency);
  }

  setInput (args) {
    let input = args.INPUT;
    if (input === 'webcam') {
      this.input = this.runtime.ioDevices.video.provider.video;
    } else {
      this.input = this.canvas;
    }
  }

  uploadButtonClicked(uploadWindow) {
    let files = uploadWindow.document.getElementById('upload-files').files;

    if (files.length <= 0) {
      uploadWindow.alert('Please select JSON file.');
      return false;
    }

    let fr = new FileReader();

    fr.onload = (e) => {
      let data = JSON.parse(e.target.result);
      this.knnClassifier.load(data, () => {
        console.log('uploaded!');

        this.updateCounts();
        alert(Message.uploaded[this.locale]);
      });
    }

    fr.onloadend = (e) => {
      uploadWindow.document.getElementById('upload-files').value = "";
    }

    fr.readAsText(files.item(0));
    uploadWindow.close();
  }

  classify() {
    let numLabels = this.knnClassifier.getNumLabels();
    if (numLabels == 0) return;

    let features = this.featureExtractor.infer(this.input);
    this.knnClassifier.classify(features, (err, result) => {
      if (err) {
        console.error(err);
      } else {
        this.label = this.getTopConfidenceLabel(result.confidencesByLabel);
        this.when_received = true;
        this.when_received_arr[this.label] = true
      }
    });
  }

  getTopConfidenceLabel(confidences) {
    let topConfidenceLabel;
    let topConfidence = 0;

    for (let label in confidences) {
      if (confidences[label] > topConfidence) {
        topConfidenceLabel = label;
      }
    }

    return topConfidenceLabel;
  }

  updateCounts() {
    this.counts = this.knnClassifier.getCountByLabel();
    console.debug(this.counts);
  }

  actionRepeated() {
    let currentTime = Date.now();
    if (this.blockClickedAt && (this.blockClickedAt + 250) > currentTime) {
      console.log('Please do not repeat trigerring this block.');
      this.blockClickedAt = currentTime;
      return true;
    } else {
      this.blockClickedAt = currentTime;
      return false;
    }
  }

  getMenu(name) {
    let arr = [];
    let defaultValue = 'any';
    let text = Message.any[this.locale];
    if (name == 'reset') {
      defaultValue = 'all';
      text = Message.all[this.locale];
    }
    arr.push({text: text, value: defaultValue});
    for(let i = 1; i <= 10; i++) {
      let obj = {};
      obj.text = i.toString(10);
      obj.value = i.toString(10);
      arr.push(obj);
    };
    return arr;
  }

  getTrainMenu() {
    let arr = [];
    for(let i = 4; i <= 10; i++) {
      let obj = {};
      obj.text = i.toString(10);
      obj.value = i.toString(10);
      arr.push(obj);
    };
    return arr;
  }

  getVideoMenu() {
    return [
      {
        text: Message.off[this.locale],
        value: 'off'
      },
      {
        text: Message.on[this.locale],
        value: 'on'
      },
      {
        text: Message.video_on_flipped[this.locale],
        value: 'on-flipped'
      }
    ]
  }

  getInputMenu() {
    return [
      {
        text: Message.webcam[this.locale],
        value: 'webcam'
      },
      {
        text: Message.stage[this.locale],
        value: 'stage'
      }
    ]
  }

  getClassificationIntervalMenu() {
    return [
      {
        text: '1',
        value: '1'
      },
      {
        text: '0.5',
        value: '0.5'
      },
      {
        text: '0.2',
        value: '0.2'
      },
      {
        text: '0.1',
        value: '0.1'
      }
    ]
  }

  getClassificationMenu() {
    return [
      {
        text: Message.off[this.locale],
        value: 'off'
      },
      {
        text: Message.on[this.locale],
        value: 'on'
      }
    ]
  }

  firstTrainingWarning() {
    if (this.firstTraining) {
      alert(Message.first_training_warning[this.locale]);
      this.firstTraining = false;
    }
  }

  setLocale() {
    let locale = formatMessage.setup().locale;
    if (AvailableLocales.includes(locale)) {
      return locale;
    } else {
      return 'en';
    }
  }
}

exports.blockClass = Scratch3ML2ScratchBlocks; // loadable-extension needs this line.
module.exports = Scratch3ML2ScratchBlocks;
