const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Clone = require('../../util/clone');
const Cast = require('../../util/cast');
const Timer = require('../../util/timer');
const nets = require('nets');
const iconURI ="data:image/png;base64,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UmVhZHlxyWU8AAADI2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6N0YwNzExMTZEODlFMTFFQUJDNTNFMUMxOTEwNEY3NUIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6N0YwNzExMTdEODlFMTFFQUJDNTNFMUMxOTEwNEY3NUIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3RjA3MTExNEQ4OUUxMUVBQkM1M0UxQzE5MTA0Rjc1QiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3RjA3MTExNUQ4OUUxMUVBQkM1M0UxQzE5MTA0Rjc1QiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pk9MjxAAAB8TSURBVHja7H0JmBXlme5bdU6dfe29oWmWRmiWsIuIGyq4DBdUjCbcSWLAPLmJEyeT3CzjOJmbdRzv5JlknmsMSpKJmjh6474b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 ";

const formatMessage = require('format-message');

// let base_url = 'https://cognimate.me:2636/nlc';
let base_url = 'https://cognimate.me:2635/nlc';
let read_api; 
let write_api;
let username; 
let classifier_name; //name of classifier to use
let class_name; //name of class that goes w/ the classifier
let results; //stores all results and probability
let label; //result with the highest probability

class Scratch3TextClassify {
    constructor (runtime) {
        this.runtime = runtime;

    }

    getInfo () {
        return {
            id: 'text',
            name: formatMessage({
                id: 'text.textTraining',
                default: 'TC w scratch',
                description: ''
            }), 
            blockIconURI: iconURI,
            blocks: [
                {
                    opcode: 'setReadAPI',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'text.setReadAPI',
                        default: 'Set Read API key to',
                        description: ''
                    }) + ' [KEY]',
                    arguments:{
                        KEY:{
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'general.key',
                                default: 'key',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'setWriteAPI',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'text.setWriteAPI',
                        default: 'Set Write API key to',
                        description: ''
                    }) + ' [KEY]',
                    arguments:{
                        KEY:{
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'general.key',
                                default: 'key',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'setUsername',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'text.setUsername',
                        default: 'Set username to',
                        description: ''
                    }) + ' [USER]',
                    arguments:{
                        USER:{
                            type: ArgumentType.STRING,
                            defaultValue: ''
                        }
                    }
                },
                {
                    opcode: 'getClassifier',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'text.getClassifier',
                        default: 'Choose text model',
                        description: ''
                    }) + ': [IDSTRING]',
                    arguments: {
                        IDSTRING: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'text.modelName',
                                default: 'model name',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'getClass',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'text.setCategory',
                        default: 'Set category to train',
                        description: ''
                    }) + ': [CLASS]',
                    arguments: {
                        CLASS: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'text.categoryName',
                                default: 'category name',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'trainText',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'text.trainText',
                        default: 'Send texts [TEXT] to train',
                        description: ''
                    }),
                    arguments: {
                        TEXT: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'general.insertText',
                                default: 'insert text',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'classifyText',
                    blockType: BlockType.REPORTER,
                    text: formatMessage({
                        id: 'text.classifyText',
                        default: 'What kind of phrase is [TEXT]?',
                        description: ''
                    }),
                    arguments: {
                        TEXT: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'text.phrase',
                                default: 'phrase',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'getScore',
                    blockType: BlockType.REPORTER,
                    text: formatMessage({
                        id: 'text.getScore',
                        default: 'How sure are you the text is a [CLASS]?',
                        description: ''
                    }),
                    arguments:{
                        CLASS: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'general.addCategory',
                                default: 'add category here',
                                description: ''
                            })
                        }
                    }
                },
                {
                    opcode: 'textHat',
                    blockType: BlockType.HAT,
                    text: formatMessage({
                        id: 'text.whenText',
                        default: 'When text is a [CLASS]?',
                        description: ''
                    }),
                    arguments:{
                        CLASS: {
                            type: ArgumentType.STRING,
                            defaultValue: formatMessage({
                                id: 'general.addCategory',
                                default: 'add category here',
                                description: ''
                            })
                        }
                    }
                }
            ],
            menus: {
                models: ['Default','RockPaperScissors'],
            }
        };
    }

    setReadAPI(args, util){
        read_api = args.KEY;
    }

    setWriteAPI(args, util){
        write_api = args.KEY;
    }

    setUsername(args, util){
        username = args.USER;
    }

    getClassifier(args, util){
        classifier_name = args.IDSTRING;
    }

    getClass(args, util){
        class_name = args.CLASS;
    }

    classifyText(args, util, callback){
        //make sure everything necessary has been set
        if(read_api == null){
            return 'Set a Read API Key';
        } else if (username == null){
            return 'No username was set';
        } else if(classifier_name == null){
            return 'No classifier name was set';
        }

        let phrase = args.TEXT;

        if (this._lastPhrase === phrase &&
            this._lastResult !== null) {
            return this._lastResult;
        }

        this._lastPhrase = phrase;
        const _this = this;
        let promise = new Promise((resolve)=>{
        this.makeClassifyCall(phrase,
            function(err, response) {
            if (err){
                console.log(err);
            }
            else {
                console.log(response);
                resp_result = JSON.parse(response.body, null, 2);
                results = {};
                //store everything
                for (var i = 0, length = resp_result.length; i < length; i++) {
                    results[resp_result[i].className.toLowerCase()] = resp_result[i].p;
                }
                //figure out the highest scoring class
                var class_label;
                var best_score = 0;
                for (var key in results) {
                    if (results.hasOwnProperty(key)) {
                        if(results[key]>best_score){
                            best_score = results[key];
                            class_label = key;
                        }
                    }
                }
                console.log(results);
                label = class_label;
                _this._lastResult = label;
                resolve(label);
            }});
        });
        promise.then(output => output);

        return promise;
    }

    makeClassifyCall(phrase, callback){
        var formData = JSON.stringify({ 
            classifier_id: classifier_name,
            classify_username: username,
            phrase: phrase,
            token: read_api
        });

        nets({
            url: base_url + "/classify/",
            headers: {
              'Content-Type': 'application/json' // important header to be included henceforth
            }, // couldn't figure out how to get x-url-encoded content-type to work
            method: 'POST',
            body: formData,
            encoding: undefined // This is important to get response as a string otherwise it returns a buffer array
          }, function(err, response){
                callback(err, response);
        });
    }

    trainText(args, util){
         //make sure everything necessary has been set
         if(write_api == null){
            return 'Set a Write API Key';
        } else if (class_name == null){
            return 'No class name was set';
        } else if(classifier_name == null){
            return 'No classifier name was set';
        }

        let phrase = args.TEXT;

        if (this._lastTrainPhrase === phrase &&
            this._lastTrainResult !== null) {
            return this._lastTrainResult;
        }

        this._lastTrainPhrase = phrase;
        const _this = this;
        let promise = new Promise((resolve)=>{
        this.makeTrainingCall(phrase,
            function(err, response) {
            if (err){
                console.log(err);
            }
            else {
                result = 'Text Data Sent';
                _this._lastTrainResult = result;
                resolve(result);
            }});
        });
        promise.then(output => output);

        return promise;
    }

    makeTrainingCall(phrase, callback){
        var formData = JSON.stringify({ 
            classifier_name: classifier_name,
            class_name: class_name,
            texts: [phrase],
            write_token: write_api
        });

        nets({
            url: base_url + "/addExamples",
            headers: {
              'Content-Type': 'application/json' // important header to be included henceforth
            }, // couldn't figure out how to get x-url-encoded content-type to work
            method: 'POST',
            body: formData,
            encoding: undefined // This is important to get response as a string otherwise it returns a buffer array
          }, function(err, response){
                callback(err, response);
        });

    }

    getScore(args, util){
        //check that classes is not empty
        if(results === null){
            return 'did you classify any text yet?'
        }
        var comparison_class = args.CLASS.toLowerCase();
        console.log(results);
        //make sure the class entered is valid
        if(!results.hasOwnProperty(comparison_class)){
            return 'this is not a valid class'
        }
        return results[comparison_class];
    }

    textHat(args, util){
        let category = args.CLASS;
        if(label == category){
            return true;
        } else{
            return false;
        }
    }


}

module.exports = Scratch3TextClassify;
