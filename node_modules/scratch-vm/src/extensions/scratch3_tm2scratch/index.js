const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const MathUtil = require('../../util/math-util');
const log = require('../../util/log');
const formatMessage = require('format-message');
const blockIconURI = 'data:image/png;base64,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UmVhZHlxyWU8AAADI2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODFFNTAyODFEODlFMTFFQThGMEVENUZCNjc3Nzk2M0YiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODFFNTAyODJEODlFMTFFQThGMEVENUZCNjc3Nzk2M0YiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4MUU1MDI3RkQ4OUUxMUVBOEYwRUQ1RkI2Nzc3OTYzRiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4MUU1MDI4MEQ4OUUxMUVBOEYwRUQ1RkI2Nzc3OTYzRiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pr42aDMAACMCSURBVHja7HxpmF1Vme679nTmqjqnxlNThkpC5pCEISFAMICoEMHgBK1oNzg8Xq59BbQVfS7oo1dt8doqtIA4tKiNTEIYNIEM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';
const path = require('path');

const Message = {
    image_classification_model_url: {
        'ja': '画像分類モデルURL[URL]',
        'ja-Hira': 'がぞうぶんるいモデル[URL]',
        'en': 'image classification model URL [URL]',
        'ko': '이미지 분류 모델 URL [URL]',
        'zh-tw':'影像分類模型網址[URL]'
    },
    image_classification_sample_model_url: {
        'ja': 'https://teachablemachine.withgoogle.com/models/0rX_3hoH/',
        'ja-Hira': 'https://teachablemachine.withgoogle.com/models/0rX_3hoH/',
        'en': ' ',
        'ko': ' ',
        'zh-tw': ' '
    },
    sound_classification_model_url: {
        'ja': '音声分類モデルURL[URL]',
        'ja-Hira': 'おんせいぶんるいモデル[URL]',
        'en': 'sound classification model URL [URL]',
        'ko': '소리 분류 모델 URL [URL]',
        'zh-tw':'聲音分類模型網址[URL]'
    },
    sound_classification_sample_model_url: {
        'ja': 'https://teachablemachine.withgoogle.com/models/xP0spGSB/',
        'ja-Hira': 'https://teachablemachine.withgoogle.com/models/xP0spGSB/',
        'en': ' ',
        'ko': ' ',
        'zh-tw': ' '
    },
    classify_image: {
        'ja': '画像を分類する',
        'ja-Hira': 'がぞうをぶんるいする',
        'en': 'classify image',
        'ko': '이미지 분류하기',
        'zh-tw':'影像分類'
    },
    image_label: {
        'ja': '画像ラベル',
        'ja-Hira': 'がぞうラベル',
        'en': 'image label',
        'ko': '이미지 라벨',
        'zh-tw':'影像標籤'
    },
    sound_label: {
        'ja': '音声ラベル',
        'ja-Hira': 'おんせいラベル',
        'en': 'sound label',
        'ko': '소리 라벨',
        'zh-tw': '聲音標籤'
    },
    when_received_block: {
        'ja': '画像ラベル[LABEL]を受け取ったとき',
        'ja-Hira': 'がぞうラベル[LABEL]をうけとったとき',
        'en': 'when received image label:[LABEL]',
        'ko': '[LABEL] 이미지 라벨을 받았을 때:',
        'zh-cn': '接收到类别[LABEL]时',
        'zh-tw':'接收到影像標籤:[LABEL]時'
    },
    is_image_label_detected: {
        'ja': '[LABEL]の画像が見つかった',
        'ja-Hira': '[LABEL]のがぞうがみつかった',
        'en': 'image [LABEL] detected',
        'ko': '[LABEL] 이미지가 감지됨',
        'zh-tw':'影像[LABEL]被偵測？'
    },
    is_sound_label_detected: {
        'ja': '[LABEL]の音声が聞こえた',
        'ja-Hira': '[LABEL]のおんせいがきこえた',
        'en': 'sound [LABEL] detected',
        'ko': '[LABEL] 소리가 감지됨',
        'zh-tw':'聲音[LABEL]被偵測？'
    },
    image_label_confidence: {
        'ja': '画像ラベル[LABEL]の確度',
        'ja-Hira': 'がぞうラベル[LABEL]のかくど',
        'en': 'confidence of image [LABEL]',
        'ko': '[LABEL] 이미지 신뢰도',
        'zh-tw':'影像置信度[LABEL]'
    },
    sound_label_confidence: {
        'ja': '音声ラベル[LABEL]の確度',
        'ja-Hira': 'おんせいラベル[LABEL]のかくど',
        'en': 'confidence of sound [LABEL]',
        'ko': '[LABEL] 소리 신뢰도',
        'zh-tw': '聲音置信度[LABEL]'
    },
    when_received_sound_label_block: {
        'ja': '音声ラベル[LABEL]を受け取ったとき',
        'ja-Hira': '音声ラベル[LABEL]をうけとったとき',
        'en': 'when received sound label:[LABEL]',
        'zh-cn': '接收到声音类别[LABEL]时',
        'ko': '[LABEL] 소리 라벨을 받았을 때:',
        'zh-tw': '接收到聲音標籤[LABEL]時'
    },
    label_block: {
        'ja': 'ラベル',
        'ja-Hira': 'ラベル',
        'en': 'label',
        'zh-cn': '标签',
        'ko': '라벨',
        'zh-tw': '標籤'
    },
    any: {
        'ja': 'のどれか',
        'ja-Hira': 'のどれか',
        'en': 'any',
        'zh-cn': '任何',
        'ko': '어떤',
        'zh-tw': '任何'
    },
    any_without_of: {
      'ja': 'どれか',
      'ja-Hira': 'どれか',
      'en': 'any',
      'ko': '어떤',
      'zh-cn': '任何',
      'zh-tw':'任何'
    },
    all: {
        'ja': 'の全て',
        'ja-Hira': 'のすべて',
        'en': 'all',
        'ko': '모든',
        'zh-cn': '所有',
        'zh-tw': '全部'
    },
    toggle_classification: {
        'ja': 'ラベル付けを[CLASSIFICATION_STATE]にする',
        'ja-Hira': 'ラベルづけを[CLASSIFICATION_STATE]にする',
        'en': 'turn classification [CLASSIFICATION_STATE]',
        'ko': '라벨 분류 [CLASSIFICATION_STATE]',
        'zh-cn': '[CLASSIFICATION_STATE]分类',
        'zh-tw':'[CLASSIFICATION_STATE]分類'
    },
    set_confidence_threshold: {
        'ja': '確度のしきい値を[CONFIDENCE_THRESHOLD]にする',
        'ja-Hira': 'かくどのしきいちを[CONFIDENCE_THRESHOLD]にする',
        'en': 'set confidence threshold [CONFIDENCE_THRESHOLD]',
        'ko': '신뢰도 기준 설정 [CONFIDENCE_THRESHOLD]',
        'zh-tw':'設定置信度閾值[CONFIDENCE_THRESHOLD]'
    },
    get_confidence_threshold: {
        'ja': '確度のしきい値',
        'ja-Hira': 'かくどのしきいち',
        'en': 'confidence threshold',
        'ko': '신뢰도 기준',
        'zh-tw':'置信度閾值'
    },
    set_classification_interval: {
        'ja': 'ラベル付けを[CLASSIFICATION_INTERVAL]秒間に1回行う',
        'ja-Hira': 'ラベルづけを[CLASSIFICATION_INTERVAL]びょうかんに1かいおこなう',
        'en': 'Label once every [CLASSIFICATION_INTERVAL] seconds',
        'zh-cn': '每隔[CLASSIFICATION_INTERVAL]秒标记一次',
        'ko': '매 [CLASSIFICATION_INTERVAL]초마다 라벨 분류하기',
        'zh-tw':'每隔[CLASSIFICATION_INTERVAL]秒標記一次'
    },
    video_toggle: {
        'ja': 'ビデオを[VIDEO_STATE]にする',
        'ja-Hira': 'ビデオを[VIDEO_STATE]にする',
        'en': 'turn video [VIDEO_STATE]',
        'zh-cn': '[VIDEO_STATE]摄像头',
        'ko':'비디오 화면 [VIDEO_STATE]',
        'zh-tw':'視訊設為[VIDEO_STATE]'
    },
    on: {
        'ja': '入',
        'ja-Hira': 'いり',
        'en': 'on',
        'ko': '켜기',
        'zh-cn': '开启',
        'zh-tw':'開啟'
    },
    off: {
        'ja': '切',
        'ja-Hira': 'きり',
        'en': 'off',
        'ko': '멈추기',
        'zh-cn': '关闭',
        'zh-tw':'關閉'
    },
    video_on_flipped: {
        'ja': '左右反転',
        'ja-Hira': 'さゆうはんてん',
        'en': 'on flipped',
        'ko': '좌우 뒤집기',
        'zh-cn': '镜像开启',
        'zh-tw':'翻轉'
    }
};

const AvailableLocales = ['en', 'ja', 'ja-Hira', 'ko', 'zh-cn', 'zh-tw'];

class Scratch3TM2ScratchBlocks {
    constructor (runtime) {
        this.runtime = runtime;
        this.locale = this.setLocale();

        this.video = document.createElement('video');
        this.video.autoplay = true;

        this.interval = 1000;
        this.minInterval = 100;

        const media = navigator.mediaDevices.getUserMedia({
            video: {
                width: 360,
                height: 360
            },
            audio: false
        });

        media.then(stream => {
            this.video.srcObject = stream;
        });

        this.timer = setInterval(() => {
            this.classifyVideoImage();
        }, this.minInterval);

        this.imageModelUrl = null;
        this.imageMetadata = null;
        this.imageClassifier = null;
        this.initImageProbableLabels();
        this.confidenceThreshold = 0.5;

        this.soundModelUrl = null;
        this.soundMetadata = null;
        this.soundClassifier = null;
        this.soundClassifierEnabled = false;
        this.initSoundProbableLabels();

        this.runtime.ioDevices.video.enableVideo();

        let script = document.createElement('script');
        script.src = 'https://stretch3.github.io/ml5-library/ml5.min.js';
        document.head.appendChild(script);
    }

    /**
     * Initialize the result of image classification.
     */
    initImageProbableLabels () {
        this.imageProbableLabels = [];
    }

    initSoundProbableLabels () {
        this.soundProbableLabels = [];
    }

    getInfo () {
        this.locale = this.setLocale();

        return {
            id: 'tm2scratch',
            name: 'TM w Scratch',
            blockIconURI: blockIconURI,
            blocks: [
                {
                    opcode: 'whenReceived',
                    text: Message.when_received_block[this.locale],
                    blockType: BlockType.HAT,
                    arguments: {
                        LABEL: {
                            type: ArgumentType.STRING,
                            menu: 'received_menu',
                            defaultValue: Message.any[this.locale]
                        }
                    }
                },
                {
                    opcode: 'isImageLabelDetected',
                    text: Message.is_image_label_detected[this.locale],
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        LABEL: {
                            type: ArgumentType.STRING,
                            menu: 'image_labels_menu',
                            defaultValue: Message.any_without_of[this.locale]
                        }
                    }
                },
                {
                    opcode: 'imageLabelConfidence',
                    text: Message.image_label_confidence[this.locale],
                    blockType: BlockType.REPORTER,
                    disableMonitor: true,
                    arguments: {
                        LABEL: {
                            type: ArgumentType.STRING,
                            menu: 'image_labels_without_any_menu',
                            defaultValue: ''
                        }
                    }
                },
                {
                    opcode: 'setImageClassificationModelURL',
                    text: Message.image_classification_model_url[this.locale],
                    blockType: BlockType.COMMAND,
                    arguments: {
                        URL: {
                            type: ArgumentType.STRING,
                            defaultValue: Message.image_classification_sample_model_url[this.locale]
                        }
                    }
                },
                {
                    opcode: 'classifyVideoImageBlock',
                    text: Message.classify_image[this.locale],
                    blockType: BlockType.COMMAND
                },
                {
                    opcode: 'getImageLabel',
                    text: Message.image_label[this.locale],
                    blockType: BlockType.REPORTER
                },
                '---',
                {
                    opcode: 'whenReceivedSoundLabel',
                    text: Message.when_received_sound_label_block[this.locale],
                    blockType: BlockType.HAT,
                    arguments: {
                        LABEL: {
                            type: ArgumentType.STRING,
                            menu: 'received_sound_label_menu',
                            defaultValue: Message.any[this.locale]
                        }
                    }
                },
                {
                    opcode: 'isSoundLabelDetected',
                    text: Message.is_sound_label_detected[this.locale],
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        LABEL: {
                            type: ArgumentType.STRING,
                            menu: 'sound_labels_menu',
                            defaultValue: Message.any_without_of[this.locale]
                        }
                    }
                },
                {
                    opcode: 'soundLabelConfidence',
                    text: Message.sound_label_confidence[this.locale],
                    blockType: BlockType.REPORTER,
                    disableMonitor: true,
                    arguments: {
                        LABEL: {
                            type: ArgumentType.STRING,
                            menu: 'sound_labels_without_any_menu',
                            defaultValue: ''
                        }
                    }
                },
                {
                    opcode: 'setSoundClassificationModelURL',
                    text: Message.sound_classification_model_url[this.locale],
                    blockType: BlockType.COMMAND,
                    arguments: {
                        URL: {
                            type: ArgumentType.STRING,
                            defaultValue: Message.sound_classification_sample_model_url[this.locale]
                        }
                    }
                },
                {
                    opcode: 'getSoundLabel',
                    text: Message.sound_label[this.locale],
                    blockType: BlockType.REPORTER
                },
                '---',
                {
                    opcode: 'toggleClassification',
                    text: Message.toggle_classification[this.locale],
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CLASSIFICATION_STATE: {
                            type: ArgumentType.STRING,
                            menu: 'classification_menu',
                            defaultValue: 'off'
                        }
                    }
                },
                {
                    opcode: 'setClassificationInterval',
                    text: Message.set_classification_interval[this.locale],
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CLASSIFICATION_INTERVAL: {
                            type: ArgumentType.STRING,
                            menu: 'classification_interval_menu',
                            defaultValue: '1'
                        }
                    }
                },
                {
                    opcode: 'setConfidenceThreshold',
                    text: Message.set_confidence_threshold[this.locale],
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CONFIDENCE_THRESHOLD: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0.5
                        }
                    }
                },
                {
                    opcode: 'getConfidenceThreshold',
                    text: Message.get_confidence_threshold[this.locale],
                    blockType: BlockType.REPORTER,
                    disableMonitor: true
                },
                {
                    opcode: 'videoToggle',
                    text: Message.video_toggle[this.locale],
                    blockType: BlockType.COMMAND,
                    arguments: {
                        VIDEO_STATE: {
                            type: ArgumentType.STRING,
                            menu: 'video_menu',
                            defaultValue: 'off'
                        }
                    }
                }
            ],
            menus: {
                received_menu: {
                    acceptReporters: true,
                    items: 'getLabelsMenu'
                },
                image_labels_menu: {
                    acceptReporters: true,
                    items: 'getLabelsWithAnyWithoutOfMenu'
                },
                image_labels_without_any_menu: {
                    acceptReporters: true,
                    items: 'getLabelsWithoutAnyMenu'
                },
                received_sound_label_menu: {
                    acceptReporters: true,
                    items: 'getSoundLabelsWithoutBackgroundMenu'
                },
                sound_labels_menu: {
                    acceptReporters: true,
                    items: 'getSoundLabelsWithoutBackgroundWithAnyWithoutOfMenu'
                },
                sound_labels_without_any_menu: {
                    acceptReporters: true,
                    items: 'getSoundLabelsWithoutAnyMenu'
                },
                video_menu: this.getVideoMenu(),
                classification_interval_menu: this.getClassificationIntervalMenu(),
                classification_menu: this.getClassificationMenu()
            }
        };
    }

    /**
     * Detect change of the selected image label is the most probable one or not.
     * @param {object} args - The block's arguments.
     * @property {string} LABEL - The label to detect.
     * @return {boolean} - Whether the label is most probable or not.
     */
    whenReceived (args) {
        const label = this.getImageLabel();
        if (args.LABEL === Message.any[this.locale]) {
            return label !== '';
        }
        return label === args.LABEL;
    }

    /**
     * Detect change of the selected sound label is the most probable one or not.
     * @param {object} args - The block's arguments.
     * @property {string} LABEL - The label to detect.
     * @return {boolean} - Whether the label is most probable or not.
     */
    whenReceivedSoundLabel (args) {
        if (!this.soundClassifierEnabled) {
            return;
        }

        const label = this.getSoundLabel();
        if (args.LABEL === Message.any[this.locale]) {
            return label !== '';
        }
        return label === args.LABEL;
    }

    /**
     * Return whether the most probable image label is the selected one or not.
     * @param {object} args - The block's arguments.
     * @property {string} LABEL - The label to detect.
     * @return {boolean} - Whether the label is most probable or not.
     */
    isImageLabelDetected (args) {
        const label = this.getImageLabel();
        if (args.LABEL === Message.any[this.locale]) {
            return label !== '';
        }
        return label === args.LABEL;
    }

    /**
     * Return whether the most probable sound label is the selected one or not.
     * @param {object} args - The block's arguments.
     * @property {string} LABEL - The label to detect.
     * @return {boolean} - Whether the label is most probable or not.
     */
    isSoundLabelDetected (args) {
        const label = this.getSoundLabel();
        if (args.LABEL === Message.any[this.locale]) {
            return label !== '';
        }
        return label === args.LABEL;
    }

    /**
     * Return confidence of the image label.
     * @param {object} args - The block's arguments.
     * @property {string} LABEL - Selected label.
     * @return {number} - Confidence of the label.
     */
    imageLabelConfidence (args) {
        if (args.LABEL === '') {
            return 0;
        }
        const entry = this.imageProbableLabels.find(element => element.label === args.LABEL);
        return (entry ? entry.confidence : 0);
    }

    /**
     * Return confidence of the sound label.
     * @param {object} args - The block's arguments.
     * @property {string} LABEL - Selected label.
     * @return {number} - Confidence of the label.
     */
    soundLabelConfidence (args) {
        if (!this.soundProbableLabels || this.soundProbableLabels.length === 0) return 0;

        if (args.LABEL === '') {
            return 0;
        }
        const entry = this.soundProbableLabels.find(element => element.label === args.LABEL);
        return (entry ? entry.confidence : 0);
    }

    /**
     * Set a model for image classification from URL.
     * @param {object} args - the block's arguments.
     * @property {string} URL - URL of model to be loaded.
     * @return {Promise} - A Promise that resolve after loaded.
     */
    setImageClassificationModelURL (args) {
        return this.loadImageClassificationModelFromURL(args.URL);
    }

    /**
     * Set a model for sound classification from URL.
     * @param {object} args - the block's arguments.
     * @property {string} URL - URL of model to be loaded.
     * @return {Promise} - A Promise that resolve after loaded.
     */
    setSoundClassificationModelURL (args) {
        return this.loadSoundClassificationModelFromURL(args.URL);
    }

    /**
     * Load a model from URL for image classification.
     * @param {string} url - URL of model to be loaded.
     * @return {Promise} - A Promise that resolves after loaded.
     */
    loadImageClassificationModelFromURL (url) {
        return new Promise(resolve => {
            const modelId = path.basename(url);
            const storageUrl = `https://storage.googleapis.com/tm-model/${modelId}/`;
            const timestamp = new Date().getTime();
            fetch(`${storageUrl}metadata.json?${timestamp}`)
                .then(res => res.json())
                .then(metadata => {
                    if (url === this.imageModelUrl &&
                        (new Date(metadata.timeStamp).getTime() === new Date(this.imageMetadata.timeStamp).getTime())) {
                        log.info(`image model already loaded: ${url}`);
                        resolve();
                    } else {
                        ml5.imageClassifier(`${storageUrl}model.json?${timestamp}`)
                            .then(classifier => {
                                this.imageModelUrl = url;
                                this.imageMetadata = metadata;
                                this.imageClassifier = classifier;
                                this.initImageProbableLabels();
                                log.info(`image model loaded from: ${url}`);
                            })
                            .catch(error => {
                                log.warn(error);
                            })
                            .finally(() => resolve());
                    }
                })
                .catch(error => {
                    log.warn(error);
                    resolve();
                });
        });
    }

    /**
     * Load a model from URL for sound classification.
     * @param {string} url - URL of model to be loaded.
     * @return {Promise} - A Promise that resolves after loaded.
     */
    loadSoundClassificationModelFromURL (url) {
        return new Promise(resolve => {
            fetch(`${url}metadata.json`)
                .then(res => res.json())
                .then(metadata => {
                    if (url === this.soundModelUrl &&
                        (new Date(metadata.timeStamp).getTime() === new Date(this.soundMetadata.timeStamp).getTime())) {
                        log.info(`sound model already loaded: ${url}`);
                        resolve();
                    } else {
                        ml5.soundClassifier(`${url}model.json`)
                            .then(classifier => {
                                this.soundModelUrl = url;
                                this.soundMetadata = metadata;
                                this.soundClassifier = classifier;
                                this.initSoundProbableLabels();
                                this.soundClassifierEnabled = true;
                                this.classifySound();
                                log.info(`sound model loaded from: ${url}`);
                            })
                            .catch(error => {
                                log.warn(error);
                            })
                            .finally(() => resolve());
                    }
                })
                .catch(error => {
                    log.warn(error);
                    resolve();
                });
        });
    }

    /**
     * Return menu items to detect label in the image.
     * @return {Array} - Menu items with 'any'.
     */
    getLabelsMenu () {
        let items = [Message.any[this.locale]];
        if (!this.imageMetadata) return items;
        items = items.concat(this.imageMetadata.labels);
        return items;
    }

    /**
     * Return menu items to detect label in the image.
     * @return {Array} - Menu items with 'any without of'.
     */
    getLabelsWithAnyWithoutOfMenu () {
        let items = [Message.any_without_of[this.locale]];
        if (!this.imageMetadata) return items;
        items = items.concat(this.imageMetadata.labels);
        return items;
    }

    /**
     * Return menu items to detect label in the image.
     * @return {Array} - Menu items with 'any'.
     */
    getSoundLabelsMenu () {
        let items = [Message.any[this.locale]];
        if (!this.soundMetadata) return items;
        items = items.concat(this.soundMetadata.wordLabels);
        return items;
    }

    /**
     * Return menu itmes to get properties of the image label.
     * @return {Array} - Menu items with ''.
     */
    getLabelsWithoutAnyMenu () {
        let items = [''];
        if (this.imageMetadata) {
            items = items.concat(this.imageMetadata.labels);
        }
        return items;
    }

    /**
     * Return menu itmes to get properties of the sound label.
     * @return {Array} - Menu items with ''.
     */
    getSoundLabelsWithoutAnyMenu () {
        if (this.soundMetadata) {
            return this.soundMetadata.wordLabels;
        } else {
            return [''];
        }
    }

    /**
     * Return menu itmes to get properties of the sound label.
     * @return {Array} - Menu items without '_background_noise_'.
     */
    getSoundLabelsWithoutBackgroundMenu () {
        let items = [Message.any[this.locale]];
        if (!this.soundMetadata) return items;
        let arr = this.soundMetadata.wordLabels;
        for (let i = 0; i < arr.length; i++) {
            if (arr[i] !== '_background_noise_') {
                items.push(arr[i]);
            }
        }
        return items;
    }

    /**
     * Return menu itmes to get properties of the sound label.
     * @return {Array} - Menu items without '_background_noise_' and with 'any without of'.
     */
    getSoundLabelsWithoutBackgroundWithAnyWithoutOfMenu () {
      let items = [Message.any_without_of[this.locale]];
      if (!this.soundMetadata) return items;
      let arr = this.soundMetadata.wordLabels;
      for (let i = 0; i < arr.length; i++) {
          if (arr[i] !== '_background_noise_') {
              items.push(arr[i]);
          }
      }
      return items;
    }

    /**
     * Pick a probability which has highest confidence.
     * @param {Array} probabilities - An Array of probabilities.
     * @property {number} probabilities.confidence - Probability of the label.
     * @return {object} - One of the highest confidence probability.
     */
    getMostProbableOne (probabilities) {
        if (probabilities.length === 0) return null;
        let mostOne = probabilities[0];
        probabilities.forEach(clss => {
            if (clss.confidence > mostOne.confidence) {
                mostOne = clss;
            }
        });
        return mostOne;
    }

    /**
     * Classify image from the video input.
     * Call stack will wait until the previous classification was done.
     *
     * @param {object} _args - the block's arguments.
     * @param {object} util - utility object provided by the runtime.
     * @return {Promise} - a Promise that resolves after classification.
     */
    classifyVideoImageBlock (_args, util) {
        if (this._isImageClassifying) {
            if (util) util.yield();
            return;
        }
        return new Promise(resolve => {
            this.classifyImage(this.video)
                .then(result => {
                    resolve(JSON.stringify(result));
                });
        });
    }

    /**
     * Classyfy image from input data source.
     *
     * @param {HTMLImageElement | ImageData | HTMLCanvasElement | HTMLVideoElement} input
     *  - Data source for classification.
     * @return {Promise} - A Promise that resolves the result of classification.
     *  The result will be empty when the imageClassifier was not set.
     */
    classifyImage (input) {
        if (!this.imageMetadata || !this.imageClassifier) {
            this._isImageClassifying = false;
            return Promise.resolve([]);
        }
        this._isImageClassifying = true;
        return this.imageClassifier.classify(input)
            .then(result => {
                this.imageProbableLabels = result.slice();
                this.imageProbableLabelsUpdated = true;
                return result;
            })
            .finally(() => {
                setTimeout(() => {
                    // Initialize probabilities to reset whenReceived blocks.
                    this.initImageProbableLabels();
                    this._isImageClassifying = false;
                }, this.interval);
            });
    }

    /**
     * Classify sound.
     */
    classifySound () {
        this.soundClassifier.classify((err, result) => {
            if (this.soundClassifierEnabled && result) {
                this.soundProbableLabels = result.slice();
                setTimeout(() => {
                    // Initialize probabilities to reset whenReceivedSoundLabel blocks.
                    this.initSoundProbableLabels();
                }, this.interval);
            }
            if (err) {
                console.error(err);
            }
        });
    }

    /**
     * Get the most probable label in the image.
     * Retrun the last classification result or '' when the first classification was not done.
     * @return {string} label
    */
    getImageLabel () {
        if (!this.imageProbableLabels || this.imageProbableLabels.length === 0) return '';
        const mostOne = this.getMostProbableOne(this.imageProbableLabels);
        return (mostOne.confidence >= this.confidenceThreshold) ? mostOne.label : '';
    }

    /**
     * Get the most probable label in the sound.
     * Retrun the last classification result or '' when the first classification was not done.
     * @return {string} label
    */
    getSoundLabel () {
        if (!this.soundProbableLabels || this.soundProbableLabels.length === 0) return '';
        const mostOne = this.getMostProbableOne(this.soundProbableLabels);
        return (mostOne.confidence >= this.confidenceThreshold) ? mostOne.label : '';
    }

    /**
     * Set confidence threshold which should be over for detected label.
     * @param {object} args - the block's arguments.
     * @property {number} CONFIDENCE_THRESHOLD - Value of confidence threshold.
     */
    setConfidenceThreshold (args) {
        let threshold = Cast.toNumber(args.CONFIDENCE_THRESHOLD);
        threshold = MathUtil.clamp(threshold, 0, 1);
        this.confidenceThreshold = threshold;
    }

    /**
     * Get confidence threshold which should be over for detected label.
     * @param {object} args - the block's arguments.
     * @return {number} - Value of confidence threshold.
     */
    getConfidenceThreshold () {
        return this.confidenceThreshold;
    }

    /**
     * Set state of the continuous classification.
     * @param {object} args - the block's arguments.
     * @property {string} CLASSIFICATION_STATE - State to be ['on'|'off'].
     */
    toggleClassification (args) {
        const state = args.CLASSIFICATION_STATE;
        if (this.timer) {
            clearTimeout(this.timer);
        }
        this.soundClassifierEnabled = false;
        if (state === 'on') {
            this.timer = setInterval(() => {
                this.classifyVideoImage();
            }, this.minInterval);
            this.soundClassifierEnabled = true;
        }
    }

    /**
     * Set interval time of the continuous classification.
     * @param {object} args - the block's arguments.
     * @property {number} CLASSIFICATION_INTERVAL - Interval time (seconds).
     */
    setClassificationInterval (args) {
        if (this.timer) {
            clearTimeout(this.timer);
        }
        this.interval = args.CLASSIFICATION_INTERVAL * 1000;
        this.timer = setInterval(() => {
            this.classifyVideoImage();
        }, this.minInterval);
    }

    /**
     * Show video image on the stage or not.
     * @param {object} args - the block's arguments.
     * @property {string} VIDEO_STATE - Show or not ['on'|'off'].
     */
    videoToggle (args) {
        const state = args.VIDEO_STATE;
        if (state === 'off') {
            this.runtime.ioDevices.video.disableVideo();
        } else {
            this.runtime.ioDevices.video.enableVideo();
            this.runtime.ioDevices.video.mirror = state === 'on';
        }
    }

    /**
     * Classify video image.
     * @return {Promise} - A Promise that resolves the result of classification.
     *  The result will be empty when another classification was under going.
     */
    classifyVideoImage () {
        if (this._isImageClassifying) return Promise.resolve([]);
        return this.classifyImage(this.video);
    }

    /**
     * Return menu for video showing state.
     * @return {Array} - Menu items.
     */
    getVideoMenu () {
        return [
            {
                text: Message.off[this.locale],
                value: 'off'
            },
            {
                text: Message.on[this.locale],
                value: 'on'
            },
            {
                text: Message.video_on_flipped[this.locale],
                value: 'on-flipped'
            }
        ];
    }

    /**
     * Return menu for classification interval setting.
     * @return {object} - Menu.
     */
    getClassificationIntervalMenu () {
        return {
            acceptReporters: true,
            items: [
                {
                    text: '1',
                    value: '1'
                },
                {
                    text: '0.5',
                    value: '0.5'
                },
                {
                    text: '0.2',
                    value: '0.2'
                },
                {
                    text: '0.1',
                    value: '0.1'
                }
            ]
        };
    }

    /**
     * Return menu for continuous classification state.
     * @return {Array} - Menu items.
     */
    getClassificationMenu () {
        return [
            {
                text: Message.off[this.locale],
                value: 'off'
            },
            {
                text: Message.on[this.locale],
                value: 'on'
            }
        ];
    }

    /**
     * Get locale for message text.
     * @return {string} - Locale of this editor.
     */
    setLocale () {
        const locale = formatMessage.setup().locale;
        if (AvailableLocales.includes(locale)) {
            return locale;
        }
        return 'en';

    }
}

module.exports = Scratch3TM2ScratchBlocks;
