const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const formatMessage = require('format-message');
const ml5 = require('ml5');

const blockIconURI = 'data:image/png;base64,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UmVhZHlxyWU8AAADI2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6N0IyQzI1MzNEODlFMTFFQUJGRENFMTkxNzFCRTFFQjkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6N0IyQzI1MzREODlFMTFFQUJGRENFMTkxNzFCRTFFQjkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3QjJDMjUzMUQ4OUUxMUVBQkZEQ0UxOTE3MUJFMUVCOSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3QjJDMjUzMkQ4OUUxMUVBQkZEQ0UxOTE3MUJFMUVCOSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pn9pDogAACEnSURBVHja7HwJlFzVeeZ/79tq6721r40kEAIBAgkjDEECYzhmdTKxHSOscAxeIHYGxwmZwcc2CdjmzMnMxNhxkuMMY+wQHJtB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';

const Message = {
  getX: {
    'ja': '[PERSON_NUMBER] 人目の [KEYPOINT] 番目の部位のx座標',
    'ja-Hira': '[PERSON_NUMBER] にんめの [KEYPOINT] ばんめのぶいのxざひょう',
    'en': 'x of person no: [PERSON_NUMBER] , keypoint no: [KEYPOINT]'
  },
  getY: {
    'ja': '[PERSON_NUMBER] 人目の [KEYPOINT] 番目の部位のy座標',
    'ja-Hira': '[PERSON_NUMBER] にんめの [KEYPOINT] ばんめのぶいのyざひょう',
    'en': 'y of person no: [PERSON_NUMBER] , keypoint no: [KEYPOINT]'
  },
  peopleCount: {
    'ja': '人数',
    'ja-Hira': 'にんずう',
    'en': 'people count'
  },
  videoToggle: {
    'ja': 'ビデオを [VIDEO_STATE] にする',
    'ja-Hira': 'ビデオを [VIDEO_STATE] にする',
    'en': 'turn video [VIDEO_STATE]'
  },
  setRatio: {
    'ja': '倍率を [RATIO] にする',
    'ja-Hira': 'ばいりつを [RATIO] にする',
    'en': 'set ratio to [RATIO]'
  },
  setInterval: {
    'ja': '認識を [INTERVAL] 秒ごとに行う',
    'ja-Hira': 'にんしきを [INTERVAL] びょうごとにおこなう',
    'en': 'Label once every [INTERVAL] seconds'
  },
  on: {
    'ja': '入',
    'ja-Hira': 'いり',
    'en': 'on'
  },
  off: {
    'ja': '切',
    'ja-Hira': 'きり',
    'en': 'off'
  },
  video_on_flipped: {
    'ja': '左右反転',
    'ja-Hira': 'さゆうはんてん',
    'en': 'on flipped',
  },
  please_wait: {
    'ja': '準備に時間がかかります。少しの間、操作ができなくなりますがお待ち下さい。',
    'ja-Hira': 'じゅんびにじかんがかかります。すこしのあいだ、そうさができなくなりますがおまちください。',
    'en': 'Setup takes a while. The browser will get stuck, but please wait.'
  }
}
const AvailableLocales = ['en', 'ja', 'ja-Hira'];

class Scratch3Facemesh2ScratchBlocks {
    get PERSON_NUMBER_MENU () {
      let person_number_menu = []
      for (let i = 1; i <= 10; i++) {
        person_number_menu.push({text: String(i), value: String(i)})
      }
      return person_number_menu;
    }

    get KEYPOINT_MENU () {
      let keypoint_menu = [];
      for (let i = 1; i <= 468; i++) {
        keypoint_menu.push({text: String(i), value: String(i)})
      }
      return keypoint_menu;
    }

    get VIDEO_MENU () {
      return [
          {
            text: Message.off[this._locale],
            value: 'off'
          },
          {
            text: Message.on[this._locale],
            value: 'on'
          },
          {
            text: Message.video_on_flipped[this._locale],
            value: 'on-flipped'
          }
      ]
    }

    get INTERVAL_MENU () {
      return [
          {
            text: '0.1',
            value: '0.1'
          },
          {
            text: '0.2',
            value: '0.2'
          },
          {
            text: '0.5',
            value: '0.5'
          },
          {
            text: '1.0',
            value: '1.0'
          }
      ]
    }

    get RATIO_MENU () {
      return [
          {
            text: '0.5',
            value: '0.5'
          },
          {
            text: '0.75',
            value: '0.75'
          },
          {
            text: '1',
            value: '1'
          },
          {
            text: '1.5',
            value: '1.5'
          },
          {
            text: '2.0',
            value: '2.0'
          }
      ]
    }

    constructor (runtime) {
        this.runtime = runtime;

        this.faces = [];
        this.ratio = 0.75;

        this.detectFace = () => {
          // We should reuse the video element created by videoProvider instead of creating a new video element
          // This is because iOS or iPad does not allow camera attached to two video elements
          this.video = this.runtime.ioDevices.video.provider.video

          alert(Message.please_wait[this._locale]);


          this.facemesh = ml5.facemesh(this.video, function() {
            console.log("Model loaded!")
          });

          this.facemesh.on('predict', faces => {
            if (faces.length < this.faces.length) {
              this.faces.splice(faces.length);
            }
            faces.forEach((face, index) => {
              this.faces[index] = {keypoints: face.scaledMesh};
            });
          });
        }

        this.runtime.ioDevices.video.enableVideo().then(this.detectFace)
    }

    getInfo () {
        this._locale = this.setLocale();

        return {
            id: 'facemesh2scratch',
            name: 'FM w Scratch',
            blockIconURI: blockIconURI,
            blocks: [
                {
                    opcode: 'getX',
                    blockType: BlockType.REPORTER,
                    text: Message.getX[this._locale],
                    arguments: {
                        PERSON_NUMBER: {
                            type: ArgumentType.STRING,
                            menu: 'personNumberMenu',
                            defaultValue: '1'
                        },
                        KEYPOINT: {
                            type: ArgumentType.STRING,
                            menu: 'keypointMenu',
                            defaultValue: '1'
                        }
                    }
                },
                {
                    opcode: 'getY',
                    blockType: BlockType.REPORTER,
                    text: Message.getY[this._locale],
                    arguments: {
                        PERSON_NUMBER: {
                            type: ArgumentType.STRING,
                            menu: 'personNumberMenu',
                            defaultValue: '1'
                        },
                        KEYPOINT: {
                            type: ArgumentType.STRING,
                            menu: 'keypointMenu',
                            defaultValue: '1'
                        }
                    }
                },
                {
                    opcode: 'getPeopleCount',
                    blockType: BlockType.REPORTER,
                    text: Message.peopleCount[this._locale]
                },
                {
                    opcode: 'videoToggle',
                    blockType: BlockType.COMMAND,
                    text: Message.videoToggle[this._locale],
                    arguments: {
                        VIDEO_STATE: {
                            type: ArgumentType.STRING,
                            menu: 'videoMenu',
                            defaultValue: 'off'
                        }
                    }
                },
                {
                    opcode: 'setVideoTransparency',
                    text: formatMessage({
                        id: 'videoSensing.setVideoTransparency',
                        default: 'set video transparency to [TRANSPARENCY]',
                        description: 'Controls transparency of the video preview layer'
                    }),
                    arguments: {
                        TRANSPARENCY: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 50
                        }
                    }
                },  
                {
                    opcode: 'setRatio',
                    blockType: BlockType.COMMAND,
                    text: Message.setRatio[this._locale],
                    arguments: {
                        RATIO: {
                            type: ArgumentType.STRING,
                            menu: 'ratioMenu',
                            defaultValue: '0.75'
                        }
                    }
                }
            ],
            menus: {
              personNumberMenu: {
                acceptReporters: true,
                items: this.PERSON_NUMBER_MENU
              },
              keypointMenu: {
                acceptReporters: true,
                items: this.KEYPOINT_MENU
              },
              videoMenu: {
                acceptReporters: true,
                items: this.VIDEO_MENU
              },
              ratioMenu: {
                acceptReporters: true,
                items: this.RATIO_MENU
              },
              intervalMenu: {
                acceptReporters: true,
                items: this.INTERVAL_MENU
              }
            }
        };
    }

    getX (args) {
      let personNumber = parseInt(args.PERSON_NUMBER, 10) - 1;
      let keypoint = parseInt(args.KEYPOINT, 10) - 1;

      if (this.faces[personNumber].keypoints && this.faces[personNumber].keypoints[keypoint]) {
        if (this.runtime.ioDevices.video.mirror === false) {
          return -1 * (240 - this.faces[personNumber].keypoints[keypoint][0] * this.ratio);
        } else {
          return 240 - this.faces[personNumber].keypoints[keypoint][0] * this.ratio;
        }
      } else {
        return "";
      }
    }

    getY (args) {
      let personNumber = parseInt(args.PERSON_NUMBER, 10) - 1;
      let keypoint = parseInt(args.KEYPOINT, 10) - 1;

      if (this.faces[personNumber].keypoints && this.faces[personNumber].keypoints[keypoint]) {
        return 180 - this.faces[personNumber].keypoints[keypoint][1] * this.ratio;
      } else {
        return "";
      }
    }

    getPeopleCount () {
      return this.faces.length;
    }

    videoToggle (args) {
      let state = args.VIDEO_STATE;
      if (state === 'off') {
        this.runtime.ioDevices.video.disableVideo();
        this.facemesh.video = null; // Stop the model prediction if video is off
      } else {
        this.facemesh.removeAllListeners('predict');
        this.runtime.ioDevices.video.enableVideo().then(this.detectFace);
        this.runtime.ioDevices.video.mirror = state === "on";
      }
    }

    /**
     * A scratch command block handle that configures the video preview's
     * transparency from passed arguments.
     * @param {object} args - the block arguments
     * @param {number} args.TRANSPARENCY - the transparency to set the video
     *   preview to
     */
    setVideoTransparency (args) {
        const transparency = Cast.toNumber(args.TRANSPARENCY);
        this.globalVideoTransparency = transparency;
        this.runtime.ioDevices.video.setPreviewGhost(transparency);
    }

    setRatio (args) {
      this.ratio = parseFloat(args.RATIO);
    }

    setLocale() {
      let locale = formatMessage.setup().locale;
      if (AvailableLocales.includes(locale)) {
        return locale;
      } else {
        return 'en';
      }
    }
}

module.exports = Scratch3Facemesh2ScratchBlocks;
