const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const log = require('../../util/log');
const ml5 = require('ml5');
const formatMessage = require('format-message');

const HAT_TIMEOUT = 100;

const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAKQ2lDQ1BJQ0MgcHJvZmlsZQAAeNqdU3dYk/cWPt/3ZQ9WQtjwsZdsgQAiI6wIyBBZohCSAGGEEBJAxYWIClYUFRGcSFXEgtUKSJ2I4qAouGdBiohai1VcOO4f3Ke1fXrv7e371/u855zn/M55zw+AERImkeaiagA5UoU8Otgfj09IxMm9gAIVSOAEIBDmy8JnBcUAAPADeXh+dLA//AGvbwACAHDVLiQSx+H/g7pQJlcAIJEA4CIS5wsBkFIAyC5UyBQAyBgAsFOzZAoAlAAAbHl8QiIAqg0A7PRJPgUA2KmT3BcA2KIcqQgAjQEAmShHJAJAuwBgVYFSLALAwgCgrEAiLgTArgGAWbYyRwKAvQUAdo5YkA9AYACAmUIszAAgOAIAQx4TzQMgTAOgMNK/4KlfcIW4SAEAwMuVzZdL0jMUuJXQGnfy8ODiIeLCbLFCYRcpEGYJ5CKcl5sjE0jnA0zODAAAGvnRwf44P5Dn5uTh5mbnbO/0xaL+a/BvIj4h8d/+vIwCBAAQTs/v2l/l5dYDcMcBsHW/a6lbANpWAGjf+V0z2wmgWgrQevmLeTj8QB6eoVDIPB0cCgsL7SViob0w44s+/zPhb+CLfvb8QB7+23rwAHGaQJmtwKOD/XFhbnauUo7nywRCMW735yP+x4V//Y4p0eI0sVwsFYrxWIm4UCJNx3m5UpFEIcmV4hLpfzLxH5b9CZN3DQCshk/ATrYHtctswH7uAQKLDljSdgBAfvMtjBoLkQAQZzQyefcAAJO/+Y9AKwEAzZek4wAAvOgYXKiUF0zGCAAARKCBKrBBBwzBFKzADpzBHbzAFwJhBkRADCTAPBBCBuSAHAqhGJZBGVTAOtgEtbADGqARmuEQtMExOA3n4BJcgetwFwZgGJ7CGLyGCQRByAgTYSE6iBFijtgizggXmY4EImFINJKApCDpiBRRIsXIcqQCqUJqkV1II/ItchQ5jVxA+pDbyCAyivyKvEcxlIGyUQPUAnVAuagfGorGoHPRdDQPXYCWomvRGrQePYC2oqfRS+h1dAB9io5jgNExDmaM2WFcjIdFYIlYGibHFmPlWDVWjzVjHVg3dhUbwJ5h7wgkAouAE+wIXoQQwmyCkJBHWExYQ6gl7CO0EroIVwmDhDHCJyKTqE+0JXoS+cR4YjqxkFhGrCbuIR4hniVeJw4TX5NIJA7JkuROCiElkDJJC0lrSNtILaRTpD7SEGmcTCbrkG3J3uQIsoCsIJeRt5APkE+S+8nD5LcUOsWI4kwJoiRSpJQSSjVlP+UEpZ8yQpmgqlHNqZ7UCKqIOp9aSW2gdlAvU4epEzR1miXNmxZDy6Qto9XQmmlnafdoL+l0ugndgx5Fl9CX0mvoB+nn6YP0dwwNhg2Dx0hiKBlrGXsZpxi3GS+ZTKYF05eZyFQw1zIbmWeYD5hvVVgq9ip8FZHKEpU6lVaVfpXnqlRVc1U/1XmqC1SrVQ+rXlZ9pkZVs1DjqQnUFqvVqR1Vu6k2rs5Sd1KPUM9RX6O+X/2C+mMNsoaFRqCGSKNUY7fGGY0hFsYyZfFYQtZyVgPrLGuYTWJbsvnsTHYF+xt2L3tMU0NzqmasZpFmneZxzQEOxrHg8DnZnErOIc4NznstAy0/LbHWaq1mrX6tN9p62r7aYu1y7Rbt69rvdXCdQJ0snfU6bTr3dQm6NrpRuoW623XP6j7TY+t56Qn1yvUO6d3RR/Vt9KP1F+rv1u/RHzcwNAg2kBlsMThj8MyQY+hrmGm40fCE4agRy2i6kcRoo9FJoye4Ju6HZ+M1eBc+ZqxvHGKsNN5l3Gs8YWJpMtukxKTF5L4pzZRrmma60bTTdMzMyCzcrNisyeyOOdWca55hvtm82/yNhaVFnMVKizaLx5balnzLBZZNlvesmFY+VnlW9VbXrEnWXOss623WV2xQG1ebDJs6m8u2qK2brcR2m23fFOIUjynSKfVTbtox7PzsCuya7AbtOfZh9iX2bfbPHcwcEh3WO3Q7fHJ0dcx2bHC866ThNMOpxKnD6VdnG2ehc53zNRemS5DLEpd2lxdTbaeKp26fesuV5RruutK10/Wjm7ub3K3ZbdTdzD3Ffav7TS6bG8ldwz3vQfTw91jicczjnaebp8LzkOcvXnZeWV77vR5Ps5wmntYwbcjbxFvgvct7YDo+PWX6zukDPsY+Ap96n4e+pr4i3z2+I37Wfpl+B/ye+zv6y/2P+L/hefIW8U4FYAHBAeUBvYEagbMDawMfBJkEpQc1BY0FuwYvDD4VQgwJDVkfcpNvwBfyG/ljM9xnLJrRFcoInRVaG/owzCZMHtYRjobPCN8Qfm+m+UzpzLYIiOBHbIi4H2kZmRf5fRQpKjKqLupRtFN0cXT3LNas5Fn7Z72O8Y+pjLk722q2cnZnrGpsUmxj7Ju4gLiquIF4h/hF8ZcSdBMkCe2J5MTYxD2J43MC52yaM5zkmlSWdGOu5dyiuRfm6c7Lnnc8WTVZkHw4hZgSl7I/5YMgQlAvGE/lp25NHRPyhJuFT0W+oo2iUbG3uEo8kuadVpX2ON07fUP6aIZPRnXGMwlPUit5kRmSuSPzTVZE1t6sz9lx2S05lJyUnKNSDWmWtCvXMLcot09mKyuTDeR55m3KG5OHyvfkI/lz89sVbIVM0aO0Uq5QDhZML6greFsYW3i4SL1IWtQz32b+6vkjC4IWfL2QsFC4sLPYuHhZ8eAiv0W7FiOLUxd3LjFdUrpkeGnw0n3LaMuylv1Q4lhSVfJqedzyjlKD0qWlQyuCVzSVqZTJy26u9Fq5YxVhlWRV72qX1VtWfyoXlV+scKyorviwRrjm4ldOX9V89Xlt2treSrfK7etI66Trbqz3Wb+vSr1qQdXQhvANrRvxjeUbX21K3nShemr1js20zcrNAzVhNe1bzLas2/KhNqP2ep1/XctW/a2rt77ZJtrWv913e/MOgx0VO97vlOy8tSt4V2u9RX31btLugt2PGmIbur/mft24R3dPxZ6Pe6V7B/ZF7+tqdG9s3K+/v7IJbVI2jR5IOnDlm4Bv2pvtmne1cFoqDsJB5cEn36Z8e+NQ6KHOw9zDzd+Zf7f1COtIeSvSOr91rC2jbaA9ob3v6IyjnR1eHUe+t/9+7zHjY3XHNY9XnqCdKD3x+eSCk+OnZKeenU4/PdSZ3Hn3TPyZa11RXb1nQ8+ePxd07ky3X/fJ897nj13wvHD0Ivdi2yW3S609rj1HfnD94UivW2/rZffL7Vc8rnT0Tes70e/Tf/pqwNVz1/jXLl2feb3vxuwbt24m3Ry4Jbr1+Hb27Rd3Cu5M3F16j3iv/L7a/eoH+g/qf7T+sWXAbeD4YMBgz8NZD+8OCYee/pT/04fh0kfMR9UjRiONj50fHxsNGr3yZM6T4aeypxPPyn5W/3nrc6vn3/3i+0vPWPzY8Av5i8+/rnmp83Lvq6mvOscjxx+8znk98ab8rc7bfe+477rfx70fmSj8QP5Q89H6Y8en0E/3Pud8/vwv94Tz+4A5JREAAAAZdEVYdFNvZnR3YXJlAEFkb2JlIEltYWdlUmVhZHlxyWU8AAADI2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6Nzc0MTMxOUVEODlFMTFFQTkwNkREQjRCNTA5MDEyM0MiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6Nzc0MTMxOUZEODlFMTFFQTkwNkREQjRCNTA5MDEyM0MiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3NzQxMzE5Q0Q4OUUxMUVBOTA2RERCNEI1MDkwMTIzQyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3NzQxMzE5REQ4OUUxMUVBOTA2RERCNEI1MDkwMTIzQyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PuhFM6EAABXASURBVHja7JsJeBRlmsffqr476SSd+wICgUDIiaLchwfqMjqIi/qI8AyoLCJe4zHi6MjqjOsMiCCOx6qMiwysO44oZkQBXVE5PICEK1wJJCQkkKNzdNJXuqv2/1aqm6ZJMEF2JWy+53m77qqvfvV+71XVgizL1NvOv4m9CHoB9gLsBdgLsLf1AuwF2AuwF2Bv6wXYC7CnNe0leE8TIWmQjyD5kChIkbqu6BzruG3u1cD21qhCSVNhpalyswqpMWRdUa8Gnm5lKrSyoGV/K1I1NHRd/vlo36UG8EbIv0JyIPpuHOeB7FWP/Ud3LypcIvXAqZAP+H5+wjkYxDTI2kvdBv4CUgmpULWO23N+eM7aRkX880f+upEOvP5RYF1o4+1+ZYI8+/9BA09CEtT5ctURuP3D1rb/mLIhOqs/+ZebSypJF24mR3U9ee0OSps2kSo3fN8OubKOchdMDx7OhktdAzUhw47b4Y52ZHiVBdspYmAqRaQnK7DamhzkrGlQQA6acR2ZUmODDzl8qTuRrKCHzlo3T51fCPk7jyhTvDWwM8+n3jRK0UavwxWAFdE/iXRhRmX4Rg5KDX4YC7tvOTGEe4gMh9TJ7W0HJDZk+03qeo/cveZRj5tyPv3qKTaQY7d1rDyQryE3QZovho71FIC7IbmQT9VQw9FbTOjmg1anr15M8HqiF/b2lrPOr5nUaevP3I94yKSLBmBHXk2h1NpKgiAEJDi3FUUxILyNp3q9PrBOq9UqyxqN5gzR6XSB9TwfOuVz8bHqcoRBEK4UBO2/YP3ypKSkr4cPH1750EMPccoYx/uuWLHikq3GnPWQ+IaDnWVgXuZ5faLPF5YpUGuez+fKiYuKys4ZPDCz0CNa7h5gpcwxk6ip1Unr16+ngoICzcsvv7yJDw0PD7/0AYZCk2VxAMmaTEn25uh12vyYuAGZfVKahySnntQ7jVfQ7MkLKDmjL/29wUcz+ybTrL6AZI6iu++ZQx6Ph6699tqPcap6Pt/1119/aQA8KwzDss/n00qSlI6lPK1AWXqDcVjawPyhAxOa+kdFymJS3q9ozJXjqbzuCdJHVFFszGXUL20J6eLG0t4GF/3zAJnGxZhoV0ULme12+vSTTyglNbli8eLFbAOrExMTKSoqSrl2jweI4Wn2+byDcDP54XptljkyOi89fUBWbHKf5OysLKFFG0kP3jGZqqu+o/iWt8gd9wvKHv4YHao9QbXFqZSW+DRlp4wni0lH68pOUKbBQFa4hr0trWQx6Om/P99AEREWSkpKPohhy0UM4fbbb+9xubC/n03+FWvXrp315BO/maG3xg3LzcqKHjV8OEnh0XQMPuexyTdQYWULXT40kQSvDOciUKOrguxh8ylt8GQsa8jrkmlS7lvUJyaMHG1eOl5vp2n9EmjjnnKSrGEUBnj1djdt/+pLirJa5ejo6P1wME6+9q233trjAIYFD9mFCxdq75137w3P//ufr7nistFkMESSNdJIaw9V0PURJoqxmGlQvETGNg9FmvRU0+Sg/KyrSSMKgapBdr9+gei8yekho05DFY2tNCG7Lxn0GqprdlJ9Yy1VlB0li8XiMJlMm9XymTRgwIAgR/QzFghgp84SXt/S0hJq5xrVxD8HIrz++uv33DF3llxaXyXbWtvkU01Ouaa5VS6tsyk7+YIqBb6QyoEvaOqVJFnC1C8e7+m9bXan/H3hXvmy/GHy+AnjT2GVBaKbMGECORyOQH97og0cumjRoie+2PIN+TwRdLy5kTJTraTXaiiOzIG8z8dTLxKXunryNjcT2WwkYN5XCyfa1EByi4O0c+9GVBcXOLFOI1IboNigfRFhJio5fJB8skT2Zjvn4kbEmXbEggRtDGhgTwOoHT169JgnFjw5MDI2hQ4eraLL0hMADzde8AkJGRmEeIOkHTtJPl6hQJPNZpLLjisDV7BYSPYBrclI5HSRqNUFgEs8KtTxfQpD3hAWRp/8o4BiomMoNy93J7awBtYilOm5BdUDBw4k49HfN3P23dCSFho1JFm5ec9fVpJv4xcE40UUHU0iA+IMJj5BmWim3UwCgEjlADl0KMnFB6CiXhKsHIqAmaC4c3K42sgLwHZHG/3X1lL6evOX1L9/f1q6dOkOf/X7qquu6rkA16xefevd987PNOtEMse0ZwLSiSqSivaQdt4cEvYVk2bwIKL9xSQ43URJiUQVJ4gaYVPLq4iKMBLrMZwPHiR65kk1DGrXPhEzPIQbW90UHRlGrTsLCb6EGhubiqn9PXJzdnY2mVmjg2LPngIwkn8+27Bh2n/e/3jAk7LiiB+tJ6OEua+2ETU0QN205D10hOzeNnKfqqZmo4Hsh+qpFl62NW8gNXldZB+VTU1xJqqrPEQO2LglyQMpUoNcGfvEWIyUGqOl177fSEmp/QCw8TNc5gjEOWPGjE7jq4u+Pf300/TCnxaFmc2mgN36c0MVFYW10e1p8WSoqaPP8tPpUJiWXFMnkBNDtkSUyGfUk6TTUzPg+LSAywfqcdv7t2EUeyg7JoXMqUNOl32wzQVHsrtol1JkyMvLOwDn0cxaV1FR0TMBvvjii5P27i7664KFf0iob2yG9ulpfXMdPXJ4B7WNzaYVcAjwCBRrjaU23GhfUUcWHNcPIKyChqwSUQKmelGkcExNGKr6jDgyGMPpZpOFmuB1C4/VUn5aHNkQVD/94VqqrrdRWnJyw+TJkz2rV69GJpJEnMKFpo4XNUCuoiDWssLz3ff7Pzyf0GRvIZNBp2hfljGMfsi9isrdTlrVWk93RSfTQFFPYVzeAiQDguZwUXNGOfusZq8lqiykCksWWcx6WldSTfc3nKS+B/fCLHj52rbp06efvPPOO2ns2LFKueyi10B+wmEYfkajkVwuF+3atWuyyRI5NTJjGIVF6sksttu/fnqTAiYPGvTLqPgunLfdYfhtJ099pdtI7Dec+ljNlGI1Udmuo5TcCqdS10KJyX3I4237josHDI6rL2pt8seLmj9nJuLPRh577DGeJkZZzBs/3rZXrijcLJeuXSLbqo8jlPPJZQ0tSsZgd7jl4uN18r7jdWdkHJI6bXS45FbX6Tedktshe08eliWPU/YUfyFLLfVnpipeWc4dPES+8cYb5YkTJ/6SM5C33nqr0/7+FABWyH2QAkg5xM33AzmgrrtP3ee8AHLa9Kc//vGpG26Z7miw1coH3n5E/npGH7n5xDF50XcHAcat3G/h0Rq51d0mbyoqa79/iaE1ym2AzOtdHq9cdKxGdiNNQ4AsS6eOoIcbZMleJXsrd2PnSnlfWZ08//3t8uKNe+Siw6Vyn6QEOTc3l0+XvH379nP29XyGMKJU+jXkN9T+HR4CLeVdbYW6LRkykto//HkeshiylMOAbl4nqWhf8XXLFr9gcji9VJVxG8Wnj6eTugSKjbJRhE5L5bUtVN2IlEyjocy+cXTwRCWVVc6lWvsomjruCapvcmIY+sjhbqMjVQ0UjRBFiB9Ie9wmShGiKTI+lnY0umjW1h9ov8ZHoq2NFr69lHITk7AtYT9nHyNHjgzY4wvxUikN8gPk3yCfQ27asmXL61D1lNTU1Onh4eGzY2Njr4LnqkFbpe7LEL9Xj+3QV3CBACLiibIolr+6uvqu5KTE8en9YqjBdZSGjRxB6ROmkFcWaXZGCtk8Ep10i3TDsH7k1oWTNcJH35U+gNz4AOVnTqSTDpEsURYyREeRFflun9QYSooKo2bJR18cXESSxkBahCkFpzyU1q8/jU5Np6Ex8LSHCqkJXv2pp576hi2c2idFuI+q+PssdEcD+SOSb1StuwVyZVNT0/tut9s4d+5c5WXMoUOHaMiQIWQwGGIwfxmXwZOTkzfCCI9Wjx1F7Z+mBeAFT7mTXq9XQLJ+M3Le+daYGLpi5CYy6eyUkX4lbqwN2ZqOdIjn2mB+GpByZSMGLK2xIwAmqmnYijgvh+pytlBZ7XoS0Kek6AiSoCexkWZ4WiNtP7gFx2H/2r9RVLiRRsJjj8C5apvddKjqFBW4HGSKiKLMzMwv29DsdjuiH1HG/cn+l1y87H/B1dUvE4zqMM1Q4S07ceJETkpKSqcHsAdFFI/koIHL3+WIo6KxGjkUTfAPZ8DSBDmy9ieq1Uahs4NgxB/8dvv2IfU2G9CIyEQkk9oPMXj4SBwXs2cWdGTWJ5EgesnurCENebl8QLCJhLCPfFK75zXrDWTUQxMdDUjhkD7DFJgRbEeaDGTQasiFbYMGZZS88sord2D3KiiBC32SEFRLDBHzDJPnGaDUVYALIC9AplRWVi7nKAJDtsMd+ZUkC78i5MYXYoiFhYWOqVOncr3pt+q5+EWNVtU8we9YoH2Z6vweDGOqqqoy4ZrRkKijR4/GYjkKDy/65MmTkThvBEaBBcczXD20Q6vX60WcQ0QYpMFI0KAf6IJGxw3LRuzDr0j1uLYOCqbDvmaeYiTpcR4DzJB33rx5/4H7W+F0Ot04jwTx4bx+UWDylMF2BSBrzlHIls8//7xx1apVd65cubLDHdERfqGjqHl9fb3yHpbTocjISIKdpGXLljXk5+ez4gyA2LCvSEHf56haqIDkzuI8HXYON0awsQIgGpFehQOquby8PAzAzVgXVltbawRYg8Ph0ELLlaGGfshms1kGoDbEmT6A8wKoZLFYRPV9sYxlEfnuyIyMDH1BQcGnuI6d91P3b2OQED7Op0LtEsD5nHZCpl933XVrrr76alqwYMFZO8GZ0IMPPki4OP3ud7+jrKysM7YDPL366qv07bff8uL9kFdZ84ITBbUvQvDbNoYa/H5XtUe+zoJwgNMBrgISmspwLQyZlyFmm81mbGlp0UPjRH5AAOsBWDceshOmxhkREeEBLC3m3dHR0W4A9mCbGxAZZBv29QGgAlHRwi4MX34BWrlv375RXGpnwcWVYcpPll/vvfbaa/Tss88q2zDM6NixY/Tcc88F3p1yu+222+iRRx6h5uZm7uQN6PxrCxcuFJ555hk5OHULnZfbSQYeNEOHaENfafL+bJvQHy+kCQ+yKWR0CAyPtfPUqVNmgA1n0DyvaquGPSwPe4YHcSGicAGeB/1VAAJeABwP464OYS7nblm6dOmwbdu2DZkzZw6NGTNGGa4MD8ZWAcPDlJd5yPA2eDF699132QsHTvTGG29wUu6eMmVKDRb7XIDMjzVxNq65Jlhbg+GqnlMx/J2ZBCiEBgqhhePTwjaKMC1CsMfl4c3C8+qD4qky3xUN5HehlejklPHjx9M111xDGBqBTxu4Ysvw+D0Bg1O1hGIQggTD48bwMdRFOv2R+E9t7MXfhibYcM1P6fQ302c11lwhSMX9YPkY1ioWav9suLNYNTANnu8KQOWkjz/+uKOoqMh8+PBhxbP6QxV2DnAMtHXrVkUDGR5ip7Pg+Y3/iBEj+BM1DZzMKA4J2LiH3ri67qz5DgornBHxJ/Z/g3ZMwg1tDzWL/mM6076ONLajzep6OXR7VwBWA0oqOlgKoxrL9o3L2gyJvReDuuWWWwhwlfVK+RgamZOTE/DMsDGKfeRjYJtc6Gwr7OMeGGgJ2izDxrA3lDdv3uy/aTkIgN8OdtRmQ/ir8n9iM4Obq8P0V9xnOv2HQ1mdL+sgqyoLsbn8l69u/W+uKzaQP6gZhiH8wfHjxx9iDYS6Kw6ENZGHMgMqLi5WniKv5wAbBlixh1arVXE6HBfyfuPGjXPAxnw9duzY2wFUwtDnmEqGc+HQQFZBdgciP7UGOv0JXLWqlf7GQHerMP1f4a9UM6ooNbD/Kgjm5u4A/NFcGNrHf+VJhSYV9unTR9EoBsdPjF8wc/rGwsOXobHt46FaV1enbOd9Bw8erBynhiLs9TYDNAe9Wm4w4Bz4arFehJcUYRaE0DTvHI0/+bWFDPNGOv2Hw5UqPG78ofrL6nxR0PbNdPovsHRBNRDBaSw8Zwm0ZitXJ958881xCFoV58GFT7aDDIy1koNmfwbCgP3Ajxw5QlxT27BhgwOAfS+99NKIDz/8sB6aKcHrKWEBzuHD0PcBoIRzyXFxcVKQJv6YFk6GrFC9Mv9fhP8Olk7d++8cn7tUzZL+ckE0kL0WbJwNQ3ExNGkyNGo1mzVAJH5PgGhdyTww7AJpGwNkeDyMOYVbsmQJ8dt82ESGYkbs9cZ7773XAmBaANdwCMGhAwtrIvYRsU7A8PZroRDkCDrr6nouf6kp50OQgby7vaxa+bcS/8mmo+b/W5g6L6jH8YOYeaGGsNLj9evXL8fD3wd7twgOY05eXl7tzp07FcfBmQV7XrZ9bPNY/JrJoDdt2sQBteOdd95xAtKRRx999F1OTgFDgcd5K7RUxLlFDmaxj8AVGRwvXH755UJH/TlH+23wQtHj7Yp0ZOVn7VGA+ufDmu+KleX6wiOBfYPn0Z68YDaQGwJfZ2lpKX8U1xofH79szZo1T82fP/9Drrbwp6979uwheFLFK7Pw+4wPPviACwicpexet24dGEstSOcewHD2cBWGS1cMDsA4AxA4eOVYjTMGmAyBtfA84sL0M7KPWvsZYLyt7TXdo+9s7NZ5zvmtSVd3HDRoUCmATMJQfB83+CZSt4KZM2f+GrYsDzbx8o8//jgZILja4QbEGmjdCQzfCNi1KwCjBCDvB/gKaBYn7z41D25PJwCvo/kgrevqv4HYhmUGYsi4dtOitbSHV/W7S9rXW8O6cp4L40QARFQ1lUWL/DX84YcffgBgHsC2SNxwNezVDgy/U1g2wgEkwCbmwL4lApIdceNKHraYOqB5Ps4f0bw4zssgoXE+/zxsoMTlJOSsXEKScA0JpkLqoiPhxp8OrLoAGQ6HPu/+bwAUs7KytHAAmlmzZsXfc8890xC+XI2bHwobGK8WSWux/XBlZeXW5cuXf4IMpZkLj5yLAjIn4V5A40Tci9iPY0Av1vmgmQpcrnb4AZaUlEhqzbSrALndpdqwgecBrqS7XrirAP32knM4DeI6DXtRaBuHcWz4ue6m5doa2zd/XY9DG/ac2C77IbIWYpnB8dTH8BgsLzM8xI8yhzVwRNL+/fuD4XUV4P/ty/9z9ScobDhDCxHaiIClQOSiKJeAuBjJIBkeOwhA8Fc0lMoFQ+NqhgpShpb51NI4x30+OKRApVeFJ4fAky9Cft0CeBZIBMUa2CnWOi4BKcLOAZokqGV6hhgoA6lTmYcrz3Mqx0AZHK/nCvE54FFPBhgKUQgGidBGQBijwGOYfg/LAP3QeBk2T/YDZXA89b+s4aoLbF6HWheSE/dYgMEQhSCIQkeCjIL8IINeA8r+eaSIsuogKMhRUMhUDkm1ejzAYHgdAQ2dD63LdQRH7gAedbLuogN4Pp92yEFApE7AdgZePhecLixfdO2nfN4WrDlCF29Y6GBoUk+DdqEAdgYzFJbQkzXsQlSke9tPrcb0tl6AvQAv1vY/AgwAC3EItK6t/AEAAAAASUVORK5CYII=';

const Message = {
  when_received_block: {
    'ja': '認識の候補を受け取ったとき',
    'ja-Hira': 'にんしきのこうほをうけとったとき',
    'en': 'when received classification candidates',
    'zh-cn': '收到分类结果时'
  },
  result1: {
    'ja': '候補1',
    'ja-Hira': 'こうほ1',
    'en': 'candidate1',
    'zh-cn': '结果1'
  },
  result2: {
    'ja': '候補2',
    'ja-Hira': 'こうほ2',
    'en': 'candidate2',
    'zh-cn': '结果2'
  },
  result3: {
    'ja': '候補3',
    'ja-Hira': 'こうほ3',
    'en': 'candidate3',
    'zh-cn': '结果3'
  },
  confidence1: {
    'ja': '確信度1',
    'ja-Hira': 'かくしんど1',
    'en': 'confidence1',
    'zh-cn': '置信度1'
  },
  confidence2: {
    'ja': '確信度2',
    'ja-Hira': 'かくしんど2',
    'en': 'confidence2',
    'zh-cn': '置信度2'
  },
  confidence3: {
    'ja': '確信度3',
    'ja-Hira': 'かくしんど3',
    'en': 'confidence3',
    'zh-cn': '置信度3'
  },
  toggle_classification: {
    'ja': '画像認識を[CLASSIFICATION_STATE]にする',
    'ja-Hira': 'がぞうにんしきを[CLASSIFICATION_STATE]にする',
    'en': 'turn classification [CLASSIFICATION_STATE]',
    'zh-cn': '[CLASSIFICATION_STATE]分类'
  },
  set_classification_interval: {
    'ja': '画像認識を[CLASSIFICATION_INTERVAL]秒間に1回行う',
    'ja-Hira': 'がぞうにんしきを[CLASSIFICATION_INTERVAL]びょうかんに1かいおこなう',
    'en': 'Classify once every [CLASSIFICATION_INTERVAL] seconds',
    'zh-cn': '每隔[CLASSIFICATION_INTERVAL]秒标记一次'
  },
  video_toggle: {
    'ja': 'ビデオを[VIDEO_STATE]にする',
    'ja-Hira': 'ビデオを[VIDEO_STATE]にする',
    'en': 'turn video [VIDEO_STATE]',
    'zh-cn': '[VIDEO_STATE]摄像头'
  },
  on: {
    'ja': '入',
    'ja-Hira': 'いり',
    'en': 'on',
    'zh-cn': '开启'
  },
  off: {
    'ja': '切',
    'ja-Hira': 'きり',
    'en': 'off',
    'zh-cn': '关闭'
  },
  video_on_flipped: {
    'ja': '左右反転',
    'ja-Hira': 'さゆうはんてん',
    'en': 'on flipped',
    'zh-cn': '镜像开启'
  }
}

const AvailableLocales = ['en', 'ja', 'ja-Hira', 'zh-cn'];

class Scratch3ImageClassifierBlocks {
  constructor (runtime) {
    this.runtime = runtime;
    this.when_received = false;
    this.results = [];
    this.locale = this.setLocale();

    this.blockClickedAt = null;

    this.interval = 1000;

    this.detect = () => {
      this.video = this.runtime.ioDevices.video.provider.video;
      this.classifier = ml5.imageClassifier('MobileNet', () => {
        console.log('Model Loaded!');
        this.timer = setInterval(() => {
          this.classify();
        }, this.interval);
      });
    }

    this.runtime.ioDevices.video.enableVideo().then(this.detect)
  }

  getInfo() {
    this.locale = this.setLocale();

    return {
      id: 'ic2scratch',
      name: 'IC w Scratch',
      blockIconURI: blockIconURI,
      blocks: [
        {
          opcode: 'getResult1',
          text: Message.result1[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getResult2',
          text: Message.result2[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getResult3',
          text: Message.result3[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getConfidence1',
          text: Message.confidence1[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getConfidence2',
          text: Message.confidence2[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'getConfidence3',
          text: Message.confidence3[this.locale],
          blockType: BlockType.REPORTER
        },
        {
          opcode: 'whenReceived',
          text: Message.when_received_block[this.locale],
          blockType: BlockType.HAT,
        },
        {
          opcode: 'toggleClassification',
          text: Message.toggle_classification[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            CLASSIFICATION_STATE: {
              type: ArgumentType.STRING,
              menu: 'classification_menu',
              defaultValue: 'off'
            }
          }
        },
        {
          opcode: 'setClassificationInterval',
          text: Message.set_classification_interval[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            CLASSIFICATION_INTERVAL: {
              type: ArgumentType.STRING,
              menu: 'classification_interval_menu',
              defaultValue: '1'
            }
          }
        },
        {
          opcode: 'videoToggle',
          text: Message.video_toggle[this.locale],
          blockType: BlockType.COMMAND,
          arguments: {
            VIDEO_STATE: {
              type: ArgumentType.STRING,
              menu: 'video_menu',
              defaultValue: 'off'
            }
          }
        },
        {
          opcode: 'setVideoTransparency',
          text: formatMessage({
              id: 'videoSensing.setVideoTransparency',
              default: 'set video transparency to [TRANSPARENCY]',
              description: 'Controls transparency of the video preview layer'
          }),
          arguments: {
              TRANSPARENCY: {
                  type: ArgumentType.NUMBER,
                  defaultValue: 50
              }
          }
        }
      ],
      menus: {
        video_menu: this.getVideoMenu(),
        classification_interval_menu: this.getClassificationIntervalMenu(),
        classification_menu: this.getClassificationMenu()
      }
    };
  }

  getResult1() {
    return this.results[0]['label'];
  }

  getResult2() {
    return this.results[1]['label'];
  }

  getResult3() {
    return this.results[2]['label'];
  }

  getConfidence1() {
    return this.results[0]['confidence'];
  }

  getConfidence2() {
    return this.results[1]['confidence'];
  }

  getConfidence3() {
    return this.results[2]['confidence'];
  }

  whenReceived(args) {
    if (this.when_received) {
      setTimeout(() => {
          this.when_received = false;
      }, HAT_TIMEOUT);
      return true;
    }
    return false;
  }

  toggleClassification (args) {
    if (this.actionRepeated()) { return };

    let state = args.CLASSIFICATION_STATE;
    if (this.timer) {
      clearTimeout(this.timer);
    }
    if (state === 'on') {
      this.timer = setInterval(() => {
        this.classify();
      }, this.interval);
    }
  }

  setClassificationInterval (args) {
    if (this.actionRepeated()) { return };

    if (this.timer) {
      clearTimeout(this.timer);
    }

    this.interval = args.CLASSIFICATION_INTERVAL * 1000;
    this.timer = setInterval(() => {
      this.classify();
    }, this.interval);
  }

  videoToggle (args) {
    if (this.actionRepeated()) { return };

    let state = args.VIDEO_STATE;
    if (state === 'off') {
      this.runtime.ioDevices.video.disableVideo();
    } else {
      this.runtime.ioDevices.video.enableVideo().then(this.detect);
      this.runtime.ioDevices.video.mirror = state === "on";
    }
  }

  /**
   * A scratch command block handle that configures the video preview's
   * transparency from passed arguments.
   * @param {object} args - the block arguments
   * @param {number} args.TRANSPARENCY - the transparency to set the video
   *   preview to
   */
  setVideoTransparency (args) {
      const transparency = Cast.toNumber(args.TRANSPARENCY);
      this.globalVideoTransparency = transparency;
      this.runtime.ioDevices.video.setPreviewGhost(transparency);
  }

  classify() {
    this.classifier.classify(this.video, (err, results) => {
      if (err) {
        console.error(err);
      } else {
        this.when_received = true;
        this.results = results;
      }
    });
  }

  actionRepeated() {
    let currentTime = Date.now();
    if (this.blockClickedAt && (this.blockClickedAt + 250) > currentTime) {
      console.log('Please do not repeat trigerring this block.');
      this.blockClickedAt = currentTime;
      return true;
    } else {
      this.blockClickedAt = currentTime;
      return false;
    }
  }

  getVideoMenu() {
    return [
      {
        text: Message.off[this.locale],
        value: 'off'
      },
      {
        text: Message.on[this.locale],
        value: 'on'
      },
      {
        text: Message.video_on_flipped[this.locale],
        value: 'on-flipped'
      }
    ]
  }

  getClassificationIntervalMenu() {
    return [
      {
        text: '5',
        value: '5'
      },
      {
        text: '2',
        value: '2'
      },
      {
        text: '1',
        value: '1'
      },
      {
        text: '0.5',
        value: '0.5'
      }
    ]
  }

  getClassificationMenu() {
    return [
      {
        text: Message.off[this.locale],
        value: 'off'
      },
      {
        text: Message.on[this.locale],
        value: 'on'
      }
    ]
  }

  setLocale() {
    let locale = formatMessage.setup().locale;
    if (AvailableLocales.includes(locale)) {
      return locale;
    } else {
      return 'en';
    }
  }
}

module.exports = Scratch3ImageClassifierBlocks;
